name: CI

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "tests/**"
      - "CMakeLists.txt"
      - "cmake/**"
      - "CMakePresets.json"
      - ".github/workflows/**"
  pull_request:
    branches: [main]
  workflow_dispatch:
  workflow_call:

jobs:
  lint:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: jidicula/clang-format-action@v4.11.0
        with:
          clang-format-version: "18"
          check-path: "src"

  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - { qt: "5.15.2", os: ubuntu-24.04, preset: release,         platform: linux,   compiler: gcc13,  modules: "" }
          - { qt: "5.15.2", os: windows-latest, preset: windows-release, platform: windows, compiler: msvc17, modules: "" }
          - { qt: "6.5.3",  os: ubuntu-24.04, preset: release,         platform: linux,   compiler: gcc13,  modules: "qtwebsockets" }
          - { qt: "6.5.3",  os: windows-latest, preset: windows-release, platform: windows, compiler: msvc17, modules: "qtwebsockets" }
          - { qt: "6.8.0",  os: ubuntu-24.04, preset: release,         platform: linux,   compiler: gcc13,  modules: "qtwebsockets" }
          - { qt: "6.8.0",  os: windows-latest, preset: windows-release, platform: windows, compiler: msvc17, modules: "qtwebsockets" }
          - { qt: "6.9.0",  os: ubuntu-24.04, preset: release,         platform: linux,   compiler: gcc13,  modules: "qtwebsockets" }
          - { qt: "6.9.0",  os: windows-latest, preset: windows-release, platform: windows, compiler: msvc17, modules: "qtwebsockets" }
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ matrix.qt }}
          modules: ${{ matrix.modules }}
          cache: true

      - name: Install X11 dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libxext-dev libxtst-dev libx11-dev

      - name: Configure
        shell: bash
        run: |
          # install-qt-action sets QT_ROOT_DIR on Linux and Qt5_DIR/Qt6_DIR variously.
          # Qt5_DIR and Qt6_DIR point to lib/cmake/Qt{5,6}/ â€” walk up to the prefix.
          if [ -n "$QT_ROOT_DIR" ]; then
            QT_PATH="$QT_ROOT_DIR"
          elif [ -n "$Qt6_DIR" ]; then
            QT_PATH="$(cd "$Qt6_DIR/../../.." && pwd)"
          elif [ -n "$Qt5_DIR" ]; then
            QT_PATH="$(cd "$Qt5_DIR/../../.." && pwd)"
          else
            echo "::error::No Qt path found in environment"
            exit 1
          fi
          echo "Using Qt prefix: $QT_PATH"
          cmake --preset ${{ matrix.preset }} -DCMAKE_PREFIX_PATH="$QT_PATH"

      - name: Build
        run: cmake --build --preset ${{ matrix.preset }}

      - name: Test
        run: ctest --preset ${{ matrix.preset }}

      - name: Install
        shell: bash
        run: cmake --install build/${{ matrix.preset }} --prefix install/${{ matrix.preset }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: qtmcp-${{ matrix.preset }}-qt${{ matrix.qt }}-${{ matrix.compiler }}
          path: install/${{ matrix.preset }}

  python:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install and test
        working-directory: python
        run: |
          pip install -e ".[dev]"
          pytest -v
