name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  ci:
    uses: ./.github/workflows/ci.yml

  release:
    needs: ci
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release archives
        shell: bash
        run: |
          mkdir -p release

          # Extract probe + launcher for each Qt version, platform, and
          # architecture, then package into per-(qt_version, platform, arch)
          # archives.
          for dir in artifacts/qtmcp-*/; do
            basename=$(basename "$dir")

            # Determine platform from preset name
            if [[ "$basename" == *"windows"* ]]; then
              platform="windows"
            else
              platform="linux"
            fi

            # Determine architecture from preset name
            if [[ "$basename" == *"x86"* ]]; then
              arch="x86"
            else
              arch="x64"
            fi

            # Extract Qt version tag from directory name (e.g., qt5.15.2 -> qt5.15)
            qt_full=$(echo "$basename" | grep -oP 'qt\K[0-9]+\.[0-9]+\.[0-9]+')
            qt_tag="qt$(echo "$qt_full" | grep -oP '^[0-9]+\.[0-9]+')"

            # Stage files into a temp directory with simplified names
            staging="staging/${qt_tag}-${platform}-${arch}"
            mkdir -p "$staging"

            # Copy probe binary with simplified name (no version/compiler suffix)
            if [ "$platform" = "windows" ]; then
              for f in "$dir"/lib/qtmcp-probe-*.dll; do
                [ -f "$f" ] && cp "$f" "$staging/qtmcp-probe.dll"
              done
              for f in "$dir"/bin/qtmcp-launcher*; do
                [ -f "$f" ] && cp "$f" "$staging/qtmcp-launcher.exe"
              done
            else
              for f in "$dir"/lib/libqtmcp-probe-*.so; do
                [ -f "$f" ] && cp "$f" "$staging/qtmcp-probe.so"
              done
              for f in "$dir"/bin/qtmcp-launcher*; do
                [ -f "$f" ] && cp "$f" "$staging/qtmcp-launcher"
              done
            fi
          done

          # Create archives from staged directories.
          # Naming: Windows always gets -x64/-x86 suffix.
          #         Linux x64 has no suffix (backward compat); Linux x86 gets -x86.
          for staging_dir in staging/*/; do
            tag_platform_arch=$(basename "$staging_dir")
            qt_tag=$(echo "$tag_platform_arch" | grep -oP '^qt[0-9]+\.[0-9]+(-patched)?')
            platform=$(echo "$tag_platform_arch" | grep -oP '(windows|linux)')
            arch=$(echo "$tag_platform_arch" | grep -oP '(x64|x86)$')

            if [ "$platform" = "windows" ]; then
              archive="qtmcp-${qt_tag}-${platform}-${arch}.zip"
              (cd "$staging_dir" && zip -j "../../release/$archive" *)
            else
              if [ "$arch" = "x86" ]; then
                archive="qtmcp-${qt_tag}-${platform}-x86.tar.gz"
              else
                archive="qtmcp-${qt_tag}-${platform}.tar.gz"
              fi
              tar -czf "release/$archive" -C "$staging_dir" .
            fi
          done

          # Generate checksums over archive files only
          cd release
          sha256sum * > SHA256SUMS
          cat SHA256SUMS

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true

  publish-pypi:
    name: Publish to PyPI
    needs: release
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    environment:
      name: pypi
      url: https://pypi.org/project/qtmcp/
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tools
        run: pip install build

      - name: Build package
        run: cd python && python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: python/dist/
