name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  ci:
    uses: ./.github/workflows/ci.yml

  release:
    needs: ci
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        shell: bash
        run: |
          mkdir -p release

          # Extract probe binaries for each Qt version and platform
          for dir in artifacts/qtmcp-*/; do
            basename=$(basename "$dir")

            # Determine platform from preset name
            if [[ "$basename" == *"windows"* ]]; then
              platform="windows"
            else
              platform="linux"
            fi

            # Extract Qt version tag from directory name (e.g., qt5.15.2 -> qt5.15)
            qt_full=$(echo "$basename" | grep -oP 'qt\K[0-9]+\.[0-9]+\.[0-9]+')
            qt_tag="qt$(echo "$qt_full" | grep -oP '^[0-9]+\.[0-9]+')"

            # Extract compiler suffix from directory name (e.g., gcc13, msvc17)
            compiler=$(echo "$basename" | grep -oP '(gcc|msvc|clang|mingw)\d+$')

            # Copy probe binaries
            if [ "$platform" = "windows" ]; then
              for f in "$dir"/lib/qtmcp-probe-*.dll; do
                [ -f "$f" ] && cp "$f" "release/qtmcp-probe-${qt_tag}-windows-${compiler}.dll"
              done
              for f in "$dir"/lib/qtmcp-probe-*.lib; do
                [ -f "$f" ] && cp "$f" "release/qtmcp-probe-${qt_tag}-windows-${compiler}.lib"
              done
            else
              for f in "$dir"/lib/libqtmcp-probe-*.so; do
                [ -f "$f" ] && cp "$f" "release/qtmcp-probe-${qt_tag}-linux-${compiler}.so"
              done
            fi

            # Copy launcher from qt6.8 cells only (one per platform)
            if [[ "$qt_full" == "6.8.0" ]]; then
              if [ "$platform" = "windows" ]; then
                for f in "$dir"/bin/qtmcp-launcher*; do
                  [ -f "$f" ] && cp "$f" "release/qtmcp-launcher-windows.exe"
                done
              else
                for f in "$dir"/bin/qtmcp-launcher*; do
                  [ -f "$f" ] && cp "$f" "release/qtmcp-launcher-linux"
                done
              fi
            fi
          done

          # Generate checksums
          cd release
          sha256sum * > SHA256SUMS
          cat SHA256SUMS

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true

  publish-pypi:
    name: Publish to PyPI
    needs: release
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    environment:
      name: pypi
      url: https://pypi.org/project/qtmcp/
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tools
        run: pip install build

      - name: Build package
        run: cd python && python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: python/dist/
