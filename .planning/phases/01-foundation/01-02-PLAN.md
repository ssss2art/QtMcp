---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/probe/core/probe.h
  - src/probe/core/probe.cpp
  - src/probe/core/probe_init_windows.cpp
  - src/probe/core/probe_init_linux.cpp
  - src/probe/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "Probe singleton can be accessed via Probe::instance()"
    - "DllMain only sets a flag and calls DisableThreadLibraryCalls"
    - "Linux constructor defers initialization until Qt is ready"
    - "No TLS or thread_local usage in probe code"
  artifacts:
    - path: "src/probe/core/probe.h"
      provides: "Probe singleton class definition"
      contains: "class Probe"
      exports: ["Probe"]
    - path: "src/probe/core/probe.cpp"
      provides: "Probe implementation"
      contains: "Probe::instance()"
    - path: "src/probe/core/probe_init_windows.cpp"
      provides: "Windows DllMain entry point"
      contains: "DllMain"
    - path: "src/probe/core/probe_init_linux.cpp"
      provides: "Linux constructor attribute entry"
      contains: "__attribute__((constructor))"
  key_links:
    - from: "src/probe/core/probe_init_windows.cpp"
      to: "src/probe/core/probe.h"
      via: "calls ensureInitialized"
      pattern: "ensureInitialized"
---

<objective>
Implement the Probe singleton with safe platform-specific initialization.

Purpose: The probe is the core component injected into Qt applications. Safe initialization is critical - Windows DllMain has severe restrictions, and Linux LD_PRELOAD runs before main(). This plan establishes the deferred initialization pattern that all subsequent probe code depends on.

Output:
- Probe singleton class with thread-safe access
- Windows DllMain that only sets flags (no Qt calls, no thread creation)
- Linux constructor that detects Qt availability and defers if needed
- InitOnce pattern for Windows, Q_GLOBAL_STATIC for cross-platform singleton
</objective>

<execution_context>
@C:\Users\stjohnson\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\stjohnson\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Probe singleton class</name>
  <files>src/probe/core/probe.h, src/probe/core/probe.cpp</files>
  <action>
Create src/probe/core/probe.h:
- Namespace: qtmcp
- Class Probe with:
  - Static instance() method returning Probe*
  - initialize() method (called after Qt is ready)
  - isInitialized() method
  - shutdown() method
  - Port configuration via setPort(quint16), port() const
  - Private constructor (singleton pattern)
  - Q_DISABLE_COPY_MOVE macro
- Use Q_GLOBAL_STATIC for singleton storage (from QtCore)
- Forward declare WebSocketServer (to be implemented later)
- NO thread_local, NO __declspec(thread), NO std::call_once

Create src/probe/core/probe.cpp:
- Implement Q_GLOBAL_STATIC(Probe, probeInstance)
- instance() returns probeInstance()
- initialize():
  - Check if already initialized (guard flag)
  - Verify QCoreApplication::instance() exists
  - Log initialization to stderr (qDebug or fprintf)
  - Set initialized flag
  - Will start WebSocket server in future plan
- shutdown(): clean up resources
- Store configuration: m_port (default 9222), m_initialized flag

Do NOT implement WebSocket functionality yet - just the skeleton.
  </action>
  <verify>
Run: cmake --build build
Expected: probe.cpp compiles without errors, no undefined symbols for Probe class
  </verify>
  <done>Probe singleton compiles and can be instantiated via Probe::instance()</done>
</task>

<task type="auto">
  <name>Task 2: Implement platform-specific entry points</name>
  <files>src/probe/core/probe_init_windows.cpp, src/probe/core/probe_init_linux.cpp, src/probe/CMakeLists.txt</files>
  <action>
Create src/probe/core/probe_init_windows.cpp:
- Include Windows.h and synchapi.h
- Static INIT_ONCE g_initOnce = INIT_ONCE_STATIC_INIT
- Static bool g_dllLoaded = false
- DllMain function:
  - DLL_PROCESS_ATTACH: DisableThreadLibraryCalls(hModule), set g_dllLoaded = true
  - DLL_PROCESS_DETACH: Call qtmcp::Probe::instance()->shutdown() only if reserved == nullptr
  - Return TRUE
  - NOTHING ELSE - no Qt calls, no thread creation, no LoadLibrary
- InitOnceCallback function for deferred init
- ensureInitialized() function: calls InitOnceExecuteOnce with callback
- The callback calls Probe::instance()->initialize()

Create src/probe/core/probe_init_linux.cpp:
- Include QtCore headers
- __attribute__((constructor)) static void onLibraryLoad():
  - If QCoreApplication::instance() exists: use QTimer::singleShot(0, ...) to initialize
  - If not: set a flag to initialize later (on first connection or via qtHookData)
- __attribute__((destructor)) static void onLibraryUnload():
  - Call Probe::instance()->shutdown()

Update src/probe/CMakeLists.txt:
- Add core/probe.h, core/probe.cpp
- Conditionally add core/probe_init_windows.cpp (WIN32)
- Conditionally add core/probe_init_linux.cpp (UNIX AND NOT APPLE)
- Remove stub file if it exists
- Add target_include_directories for src/probe

CRITICAL: Follow the patterns from 01-RESEARCH.md exactly. Windows DllMain must be minimal.
  </action>
  <verify>
Run: cmake --build build
Expected: Builds on current platform without errors, DllMain/constructor compiles
  </verify>
  <done>Platform entry points compile and follow safe initialization patterns</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Build succeeds on current platform
2. On Windows: dumpbin /exports shows DllMain entry point
3. Code review: DllMain contains ONLY DisableThreadLibraryCalls and flag set
4. Code review: No thread_local or __declspec(thread) anywhere
5. Code review: No std::call_once usage
</verification>

<success_criteria>
- Probe singleton accessible via Probe::instance()
- Platform entry points follow deferred initialization pattern
- No forbidden constructs (TLS, call_once) in codebase
- Build produces probe shared library with correct entry points
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
