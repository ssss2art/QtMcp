---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/probe/transport/jsonrpc_handler.h
  - src/probe/transport/jsonrpc_handler.cpp
  - src/probe/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "Handler parses valid JSON-RPC 2.0 requests"
    - "Handler returns proper error for invalid JSON"
    - "Handler returns proper error for missing method"
    - "Notifications (no id) return empty response"
  artifacts:
    - path: "src/probe/transport/jsonrpc_handler.h"
      provides: "JSON-RPC 2.0 handler class"
      contains: "class JsonRpcHandler"
      exports: ["JsonRpcHandler"]
    - path: "src/probe/transport/jsonrpc_handler.cpp"
      provides: "JSON-RPC parsing and formatting"
      contains: "handleRequest"
  key_links:
    - from: "src/probe/transport/jsonrpc_handler.cpp"
      to: "QJsonDocument"
      via: "JSON parsing"
      pattern: "QJsonDocument::fromJson"
---

<objective>
Implement JSON-RPC 2.0 request parsing and response formatting.

Purpose: All communication with the probe uses JSON-RPC 2.0 over WebSocket. This handler is independent of transport - it takes a string, returns a string. Clean separation allows testing without network.

Output:
- JsonRpcHandler class that parses JSON-RPC 2.0 messages
- Proper error responses for parse errors, invalid requests, method not found
- Extensible method dispatch (placeholder for future methods)
- Notification support (no response for messages without id)
</objective>

<execution_context>
@C:\Users\stjohnson\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\stjohnson\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JsonRpcHandler class</name>
  <files>src/probe/transport/jsonrpc_handler.h, src/probe/transport/jsonrpc_handler.cpp</files>
  <action>
Create src/probe/transport/jsonrpc_handler.h:
- Namespace: qtmcp
- Class JsonRpcHandler : public QObject
  - Q_OBJECT macro for signals
  - Constructor takes QObject* parent
  - QString handleRequest(const QString& message) - main entry point
  - Protected/private:
    - QJsonValue dispatchMethod(const QString& method, const QJsonValue& params)
    - QString formatResult(const QJsonValue& result, const QJsonValue& id)
    - QString formatError(int code, const QString& message, const QJsonValue& id)
  - Signals:
    - void notificationReceived(const QString& method, const QJsonValue& params)

Create src/probe/transport/jsonrpc_handler.cpp:
- handleRequest():
  - Parse JSON with QJsonDocument::fromJson
  - On parse error: return formatError(-32700, "Parse error", QJsonValue::Null)
  - Validate jsonrpc == "2.0": return formatError(-32600, "Invalid Request", id)
  - Extract method, params, id
  - If method empty: return formatError(-32600, "Invalid Request", id)
  - If id is null/undefined (notification): emit notificationReceived, return empty QString
  - Call dispatchMethod to get result
  - Return formatResult(result, id)

- dispatchMethod():
  - For now, implement one placeholder method: "qtmcp.echo" that returns params unchanged
  - Unknown methods: throw or return special error marker
  - Future plans will add real methods

- formatResult():
  - Create QJsonObject with jsonrpc="2.0", result, id
  - Return QJsonDocument::toJson(Compact)

- formatError():
  - Create QJsonObject with jsonrpc="2.0", error={code, message}, id
  - Handle null id correctly (JSON-RPC spec says include null for errors)
  - Return QJsonDocument::toJson(Compact)

Standard JSON-RPC 2.0 error codes to support:
- -32700: Parse error
- -32600: Invalid Request
- -32601: Method not found
- -32602: Invalid params (for future use)
- -32603: Internal error (for future use)

Follow the code example from 01-RESEARCH.md exactly.
  </action>
  <verify>
Run: cmake --build build
Expected: Compiles without errors
Manual test: Write a unit test or add a main() that exercises handleRequest with test strings
  </verify>
  <done>JsonRpcHandler parses JSON-RPC 2.0 and returns proper responses/errors</done>
</task>

<task type="auto">
  <name>Task 2: Update CMakeLists and add basic test</name>
  <files>src/probe/CMakeLists.txt, tests/test_jsonrpc.cpp, tests/CMakeLists.txt</files>
  <action>
Update src/probe/CMakeLists.txt:
- Add transport/jsonrpc_handler.h, transport/jsonrpc_handler.cpp
- Ensure Qt MOC processes the header (automoc should handle this)

Create tests/CMakeLists.txt:
- Enable testing with enable_testing()
- Add test executable: test_jsonrpc
- Link Qt::Core, Qt::Test (for QTest framework)
- Add test via add_test()

Create tests/test_jsonrpc.cpp:
- Use QTest framework
- Test cases:
  - test_validRequest: Send valid echo request, verify response
  - test_parseError: Send malformed JSON, verify -32700 error
  - test_invalidRequest: Send object without jsonrpc field, verify -32600
  - test_methodNotFound: Request unknown method, verify -32601
  - test_notification: Send message without id, verify empty response

Example test:
```cpp
void TestJsonRpc::test_validRequest() {
    qtmcp::JsonRpcHandler handler;
    QString request = R"({"jsonrpc":"2.0","method":"qtmcp.echo","params":{"hello":"world"},"id":1})";
    QString response = handler.handleRequest(request);

    QJsonDocument doc = QJsonDocument::fromJson(response.toUtf8());
    QCOMPARE(doc["jsonrpc"].toString(), QString("2.0"));
    QCOMPARE(doc["id"].toInt(), 1);
    QCOMPARE(doc["result"]["hello"].toString(), QString("world"));
}
```

Update root CMakeLists.txt:
- Add option(BUILD_TESTING "Build tests" ON)
- If BUILD_TESTING: add_subdirectory(tests)
  </action>
  <verify>
Run: cmake --build build && ctest --test-dir build --output-on-failure
Expected: All JSON-RPC tests pass
  </verify>
  <done>JSON-RPC handler has passing unit tests for all error codes</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Build succeeds
2. `ctest --test-dir build` runs tests
3. All test cases pass:
   - Valid request returns result
   - Parse error returns -32700
   - Invalid request returns -32600
   - Unknown method returns -32601
   - Notification returns empty string
</verification>

<success_criteria>
- JsonRpcHandler class compiles and is testable
- All JSON-RPC 2.0 error codes handled correctly
- Unit tests prove correctness
- Echo method works for integration testing
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
