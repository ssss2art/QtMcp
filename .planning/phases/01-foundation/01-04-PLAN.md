---
phase: 01-foundation
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - src/probe/transport/websocket_server.h
  - src/probe/transport/websocket_server.cpp
  - src/probe/core/probe.cpp
  - src/probe/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "WebSocket server starts on configured port"
    - "Server accepts exactly one client connection"
    - "New connections are rejected while client is connected"
    - "Server continues listening after client disconnects"
    - "Incoming messages are routed to JsonRpcHandler"
  artifacts:
    - path: "src/probe/transport/websocket_server.h"
      provides: "WebSocket server class"
      contains: "class WebSocketServer"
      exports: ["WebSocketServer"]
    - path: "src/probe/transport/websocket_server.cpp"
      provides: "Single-client WebSocket implementation"
      contains: "QWebSocketServer"
  key_links:
    - from: "src/probe/transport/websocket_server.cpp"
      to: "src/probe/transport/jsonrpc_handler.h"
      via: "message routing"
      pattern: "JsonRpcHandler"
    - from: "src/probe/core/probe.cpp"
      to: "src/probe/transport/websocket_server.h"
      via: "server startup in initialize()"
      pattern: "WebSocketServer"
---

<objective>
Implement the WebSocket server with single-client semantics and integrate with Probe.

Purpose: This is the transport layer that accepts connections from Claude or other clients. Per CONTEXT.md, only one client at a time is allowed. The server stays active after disconnect, ready for reconnection.

Output:
- WebSocketServer class using QWebSocketServer
- Single-client connection logic (reject additional connections)
- Message routing to JsonRpcHandler
- Integration with Probe::initialize()
- Startup message to stderr ("QtMCP listening on ws://...")
</objective>

<execution_context>
@C:\Users\stjohnson\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\stjohnson\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WebSocketServer class</name>
  <files>src/probe/transport/websocket_server.h, src/probe/transport/websocket_server.cpp</files>
  <action>
Create src/probe/transport/websocket_server.h:
- Namespace: qtmcp
- Class WebSocketServer : public QObject
  - Q_OBJECT macro
  - Constructor: WebSocketServer(quint16 port, QObject* parent = nullptr)
  - bool start() - start listening, return success
  - void stop() - stop listening
  - bool isListening() const
  - quint16 port() const
  - bool hasActiveClient() const
  - Signals:
    - void clientConnected()
    - void clientDisconnected()
    - void messageReceived(const QString& message)
    - void errorOccurred(const QString& error)

Create src/probe/transport/websocket_server.cpp:
- Store QWebSocketServer* m_server (created in constructor)
- Store QWebSocket* m_activeClient (null when no client)
- Store JsonRpcHandler* m_rpcHandler
- Store quint16 m_port

Constructor:
- Create QWebSocketServer with name "QtMCP" and NonSecureMode
- Create JsonRpcHandler
- Connect server's newConnection signal to onNewConnection slot

start():
- Call m_server->listen(QHostAddress::Any, m_port)
- On success: print to stderr "QtMCP listening on ws://0.0.0.0:{port}"
- Return success

onNewConnection() slot:
- Get pending connection via nextPendingConnection()
- If m_activeClient is NOT null:
  - Reject: socket->close(QWebSocketProtocol::CloseCodePolicyViolated, "Another client is already connected")
  - socket->deleteLater()
  - return
- Set m_activeClient = socket
- Connect textMessageReceived to onTextMessage
- Connect disconnected to onClientDisconnected
- Emit clientConnected()

onTextMessage(const QString& message) slot:
- QString response = m_rpcHandler->handleRequest(message)
- If response is not empty: m_activeClient->sendTextMessage(response)

onClientDisconnected() slot:
- m_activeClient->deleteLater()
- m_activeClient = nullptr
- Emit clientDisconnected()
- Note: Server keeps listening! Do NOT stop.

stop():
- If m_activeClient: close it
- m_server->close()

Follow Pattern 3 from 01-RESEARCH.md for single-client logic.
  </action>
  <verify>
Run: cmake --build build
Expected: WebSocketServer compiles, links against Qt::WebSockets
  </verify>
  <done>WebSocketServer class compiles with single-client connection logic</done>
</task>

<task type="auto">
  <name>Task 2: Integrate WebSocketServer with Probe</name>
  <files>src/probe/core/probe.h, src/probe/core/probe.cpp, src/probe/CMakeLists.txt</files>
  <action>
Update src/probe/core/probe.h:
- Add forward declaration: class WebSocketServer;
- Add member: WebSocketServer* m_server = nullptr;
- Add method: WebSocketServer* server() const;

Update src/probe/core/probe.cpp:
- Include websocket_server.h
- In initialize():
  - Verify QCoreApplication::instance() exists, log error and return if not
  - Create m_server = new WebSocketServer(m_port, this)
  - Connect server signals to probe slots for logging (optional but helpful)
  - Call m_server->start()
  - If start fails: log error, delete server, return
  - Set m_initialized = true
  - Log "QtMCP probe initialized on port {port}"

- In shutdown():
  - If m_server: call stop(), delete, set to nullptr
  - Set m_initialized = false

Update src/probe/CMakeLists.txt:
- Add transport/websocket_server.h, transport/websocket_server.cpp
- Verify Qt::WebSockets is linked

The flow is now:
1. DllMain/constructor sets flag
2. ensureInitialized() calls InitOnce/deferred init
3. Probe::initialize() creates and starts WebSocketServer
4. Server listens, accepts one client
5. Messages flow: WebSocket -> JsonRpcHandler -> response
  </action>
  <verify>
Manual test:
1. Create a minimal test app that calls Probe::instance()->initialize()
2. Run the app
3. Use websocat or a browser WebSocket client to connect
4. Send: {"jsonrpc":"2.0","method":"qtmcp.echo","params":{"test":"hello"},"id":1}
5. Receive: {"jsonrpc":"2.0","result":{"test":"hello"},"id":1}
  </verify>
  <done>Probe creates WebSocketServer on initialize, accepts connections, handles JSON-RPC</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Build succeeds
2. Manually test with a minimal Qt app:
   - App creates QCoreApplication
   - App calls Probe::instance()->initialize()
   - Server message appears on stderr
   - Connect with websocat: `websocat ws://localhost:9222`
   - Send JSON-RPC request, receive response
   - Second connection attempt is rejected
   - After first client disconnects, can reconnect
</verification>

<success_criteria>
- WebSocketServer starts on configured port
- Exactly one client allowed at a time
- JSON-RPC messages processed and responses sent
- Server survives client disconnect and accepts new connections
- Startup message printed to stderr
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
