---
phase: 01-foundation
plan: 05
type: execute
wave: 4
depends_on: ["01-04"]
files_modified:
  - src/launcher/main.cpp
  - src/launcher/injector.h
  - src/launcher/injector_windows.cpp
  - src/launcher/injector_linux.cpp
  - src/launcher/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "qtmcp-launch --help shows usage with --port, --detach, --quiet flags"
    - "On Windows, launcher injects probe DLL into target process"
    - "On Linux, launcher sets LD_PRELOAD and execs target"
    - "Launcher waits for target by default, --detach runs in background"
    - "Port is passed to probe via environment variable or shared state"
  artifacts:
    - path: "src/launcher/main.cpp"
      provides: "Launcher CLI entry point"
      contains: "QCommandLineParser"
    - path: "src/launcher/injector_windows.cpp"
      provides: "Windows DLL injection"
      contains: "CreateRemoteThread"
    - path: "src/launcher/injector_linux.cpp"
      provides: "Linux LD_PRELOAD injection"
      contains: "LD_PRELOAD"
  key_links:
    - from: "src/launcher/main.cpp"
      to: "src/launcher/injector.h"
      via: "calls launchWithProbe"
      pattern: "launchWithProbe"
---

<objective>
Implement the qtmcp-launch CLI tool with platform-specific injection.

Purpose: The launcher is how users start Qt applications with the probe injected. It provides a consistent CLI on both Windows and Linux, handles DLL injection or LD_PRELOAD setup, and optionally waits for the target process.

Output:
- qtmcp-launch executable with QCommandLineParser
- Windows: CreateRemoteThread + LoadLibrary injection
- Linux: LD_PRELOAD environment variable setup
- --port, --detach, --quiet flags per CONTEXT.md
- Consistent behavior across platforms
</objective>

<execution_context>
@C:\Users\stjohnson\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\stjohnson\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create launcher CLI with QCommandLineParser</name>
  <files>src/launcher/main.cpp, src/launcher/injector.h</files>
  <action>
Create src/launcher/injector.h:
- Namespace: qtmcp
- Function declaration:
  ```cpp
  struct LaunchOptions {
      QString targetExecutable;
      QStringList targetArgs;
      QString probePath;
      quint16 port = 9222;
      bool detach = false;
      bool quiet = false;
  };

  // Returns process ID on success, -1 on failure
  qint64 launchWithProbe(const LaunchOptions& options);
  ```

Create src/launcher/main.cpp:
- Create QCoreApplication (needed for QCommandLineParser)
- Set application name "qtmcp-launch", version "0.1.0"

Define command line options using QCommandLineParser:
- --port, -p: "WebSocket port for probe" (default 9222)
- --detach, -d: "Run in background, don't wait for target"
- --quiet, -q: "Suppress startup messages"
- --probe: "Path to probe library" (optional, auto-detect by default)
- Positional args: target executable and its arguments

Parse arguments:
- Validate target executable exists
- If --probe not specified, look for qtmcp-probe.dll/.so next to launcher
- Convert port string to quint16, validate range

Call launchWithProbe(options):
- On failure: print error to stderr, exit(1)
- On success with --detach: print PID if not quiet, exit(0)
- On success without --detach: wait for process (platform-specific)

Example usage that must work:
```
qtmcp-launch --port 9222 /path/to/app arg1 arg2
qtmcp-launch -p 9333 --detach myapp.exe
qtmcp-launch --quiet --detach app
```
  </action>
  <verify>
Run: cmake --build build && ./build/bin/qtmcp-launch --help
Expected: Shows usage with all options described
  </verify>
  <done>Launcher CLI parses arguments and shows help correctly</done>
</task>

<task type="auto">
  <name>Task 2: Implement platform-specific injection</name>
  <files>src/launcher/injector_windows.cpp, src/launcher/injector_linux.cpp, src/launcher/CMakeLists.txt</files>
  <action>
Create src/launcher/injector_windows.cpp:
- Implement launchWithProbe() for Windows:
  1. Build command line: target + args
  2. CreateProcessW with CREATE_SUSPENDED flag
  3. VirtualAllocEx in target for DLL path (wide string)
  4. WriteProcessMemory to write DLL path
  5. GetProcAddress for LoadLibraryW from kernel32
  6. CreateRemoteThread to call LoadLibraryW with DLL path
  7. WaitForSingleObject on injection thread
  8. ResumeThread on main thread
  9. If not detach: WaitForSingleObject on process handle
  10. Return process ID
- Set QTMCP_PORT environment variable before CreateProcess
- Handle errors at each step, cleanup on failure

Create src/launcher/injector_linux.cpp:
- Implement launchWithProbe() for Linux:
  1. fork()
  2. In child:
     - Set LD_PRELOAD to probe library path (prepend to existing)
     - Set QTMCP_PORT to port value
     - execvp target with args
  3. In parent:
     - If not detach: waitpid()
     - Return child PID
- Use QProcess::startDetached() as alternative if simpler

Update src/launcher/CMakeLists.txt:
- Add main.cpp, injector.h
- Conditionally add injector_windows.cpp (WIN32) or injector_linux.cpp (UNIX)
- Link Qt::Core

Update src/probe/core/probe.cpp:
- Read QTMCP_PORT environment variable in initialize() if m_port not set
- qgetenv("QTMCP_PORT").toUInt() with default 9222

Follow Pattern 4 from 01-RESEARCH.md for Windows injection.
  </action>
  <verify>
Windows: qtmcp-launch notepad.exe (process starts, probe injects)
Linux: qtmcp-launch gedit (process starts, probe injects)
Both: websocat ws://localhost:9222 connects and receives responses
  </verify>
  <done>Launcher injects probe into target process on both platforms</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. qtmcp-launch --help shows all options
2. qtmcp-launch /path/to/qt-app starts the app
3. Connect to ws://localhost:9222 (or custom port)
4. Send JSON-RPC request, receive response
5. --detach returns immediately, app keeps running
6. --quiet suppresses startup message
7. --port 9333 changes the port
</verification>

<success_criteria>
- Launcher executable builds on both platforms
- CLI follows CONTEXT.md decisions (--port, --detach, --quiet)
- Windows injection works via CreateRemoteThread
- Linux injection works via LD_PRELOAD
- Probe starts WebSocket server and responds to requests
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-05-SUMMARY.md`
</output>
