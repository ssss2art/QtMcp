---
phase: 04-computer-use-mode
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - tests/test_computer_use_api.cpp
  - tests/test_key_name_mapper.cpp
  - tests/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "All 13 cu.* methods respond to JSON-RPC calls"
    - "cu.screenshot returns valid base64 PNG with width/height"
    - "cu.click at known widget coordinates triggers that widget"
    - "cu.type sends text to focused widget"
    - "cu.key with Chrome key names sends correct Qt keys"
    - "cu.scroll sends wheel events"
    - "cu.cursorPosition returns coordinate and widget info"
    - "Out-of-bounds coordinates return error code -32061"
    - "No active window returns error code -32060"
    - "KeyNameMapper correctly maps all Chrome/xdotool aliases"
  artifacts:
    - path: "tests/test_key_name_mapper.cpp"
      provides: "Unit tests for key name mapping"
      min_lines: 60
    - path: "tests/test_computer_use_api.cpp"
      provides: "Integration tests for all cu.* methods"
      min_lines: 200
    - path: "tests/CMakeLists.txt"
      provides: "Test executable registration"
      contains: "test_computer_use_api"
  key_links:
    - from: "test_computer_use_api.cpp"
      to: "ComputerUseModeApi"
      via: "JsonRpcHandler method calls"
      pattern: "handler.*HandleMessage.*cu\\."
    - from: "test_key_name_mapper.cpp"
      to: "KeyNameMapper"
      via: "direct static method calls"
      pattern: "KeyNameMapper::resolve"
---

<objective>
Create comprehensive tests for Computer Use Mode: unit tests for KeyNameMapper and integration tests for all 13 cu.* JSON-RPC methods.

Purpose: Verify the complete Phase 4 API surface works correctly before phase verification.
Output: Two test executables (test_key_name_mapper, test_computer_use_api) covering all CU requirements.
</objective>

<execution_context>
@C:\Users\stjohnson\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\stjohnson\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-computer-use-mode/04-RESEARCH.md
@.planning/phases/04-computer-use-mode/04-CONTEXT.md
@.planning/phases/04-computer-use-mode/04-01-SUMMARY.md
@.planning/phases/04-computer-use-mode/04-02-SUMMARY.md
@tests/test_native_mode_api.cpp
@tests/CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KeyNameMapper unit tests</name>
  <files>tests/test_key_name_mapper.cpp, tests/CMakeLists.txt</files>
  <action>
Create `test_key_name_mapper.cpp` using QTest framework (follow existing test patterns in the project).

Test class: `TestKeyNameMapper` with Q_OBJECT.

**Test cases:**

1. `testResolveNavigationKeys` - verify Return, Enter (both -> Key_Return), Tab, Escape, Esc, BackSpace, Backspace, Delete, Space, space all resolve correctly.

2. `testResolveArrowKeys` - verify Up/ArrowUp -> Key_Up, Down/ArrowDown -> Key_Down, Left/ArrowLeft -> Key_Left, Right/ArrowRight -> Key_Right.

3. `testResolveFunctionKeys` - verify F1-F12 all resolve.

4. `testResolveModifierKeys` - verify Shift/Shift_L, Control/Control_L, Alt/Alt_L, Super/Super_L, Meta all resolve.

5. `testResolveCaseInsensitive` - verify "return", "RETURN", "Return" all resolve to same key. "escape", "ESCAPE", "Escape" same. "tab", "TAB", "Tab" same.

6. `testResolveUnknown` - verify "NotAKey" returns Qt::Key_unknown.

7. `testResolveSingleChar` - verify "a" -> Key_A, "z" -> Key_Z, "1" -> Key_1.

8. `testParseKeyCombo_Simple` - verify "Return" -> {Key_Return, NoModifier}, "F5" -> {Key_F5, NoModifier}.

9. `testParseKeyCombo_WithModifiers` - verify "ctrl+c" -> {Key_C, ControlModifier}, "ctrl+shift+s" -> {Key_S, Control|Shift}, "alt+F4" -> {Key_F4, AltModifier}.

10. `testParseKeyCombo_ChromeStyle` - verify "ctrl+shift+ArrowUp" -> {Key_Up, Control|Shift}.

Add to tests/CMakeLists.txt: new test executable `test_key_name_mapper` linking qtmcp_probe, Qt::Core, Qt::Test, Qt::Widgets. Register with `add_test(NAME test_key_name_mapper ...)`. Set QTMCP_ENABLED=0 environment variable for the test.
  </action>
  <verify>
`cmake --build build/ --target test_key_name_mapper` succeeds.
`ctest --test-dir build/ -R test_key_name_mapper --output-on-failure` passes all tests.
  </verify>
  <done>
10+ test cases covering key resolution (navigation, arrows, function, modifiers, case sensitivity, unknown, single char) and combo parsing (simple, with modifiers, Chrome-style). All pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ComputerUseModeApi integration tests</name>
  <files>tests/test_computer_use_api.cpp, tests/CMakeLists.txt</files>
  <action>
Create `test_computer_use_api.cpp` using QTest framework. Follow the EXACT pattern from `test_native_mode_api.cpp` for test structure (init/cleanup creating fresh JsonRpcHandler + ComputerUseModeApi + test widgets per test).

Test class: `TestComputerUseApi` with Q_OBJECT.

**Per-test setup (init/cleanup):**
- Create JsonRpcHandler
- Create ComputerUseModeApi(handler)
- Create a test QMainWindow with known-size (400x300), add a QPushButton ("clickMe") at known position, a QLineEdit ("inputField"), a QScrollArea, show the window and call QApplication::processEvents()
- In cleanup: delete all widgets, delete handler

**Helper:** `callMethod(handler, method, params)` - constructs JSON-RPC request, calls HandleMessage, parses response, returns result QJsonObject. Same pattern as test_native_mode_api.cpp.

**Test cases (organized by requirement):**

CU-01: Screenshot
1. `testScreenshot` - call cu.screenshot with no params. Verify response has "image" (non-empty string), "width" and "height" (positive integers). Decode base64 and verify PNG magic bytes (first 4 bytes after decode: 0x89 0x50 0x4E 0x47).

CU-02 through CU-04: Clicks
2. `testClick` - set up a QPushButton with clicked signal connected to a bool flag. Call cu.click with button's center coordinates (get via button->mapTo(window, button->rect().center())). Verify flag is true.
3. `testRightClick` - call cu.rightClick at coordinates. Verify success (no crash, returns success:true). Can install event filter to verify right-click event received.
4. `testDoubleClick` - call cu.doubleClick at coordinates. Verify success.

CU-05: Mouse move
5. `testMouseMove` - call cu.mouseMove with coordinates. Verify success:true.

CU-06: Drag
6. `testDrag` - call cu.drag with startX/startY/endX/endY within window bounds. Verify success:true.

CU-07: Type
7. `testType` - focus the QLineEdit (lineEdit->setFocus(), processEvents). Call cu.type with text "Hello". Verify lineEdit->text() == "Hello".

CU-08: Key
8. `testKey` - focus QLineEdit, type some text first. Call cu.key with "ctrl+a" (select all). Then cu.key with "Delete". Verify lineEdit is empty.
9. `testKeyChromeNames` - call cu.key with "Return", "Escape", "ArrowUp" - verify no errors (Chrome name compatibility).

CU-09: Scroll
10. `testScroll` - call cu.scroll with x, y, direction "down", amount 3 at center of window. Verify success:true.

CU-10: Cursor position
11. `testCursorPosition` - call cu.cursorPosition. Verify response has x, y (integers), and className (string).

Error handling:
12. `testClickOutOfBounds` - call cu.click with x=9999, y=9999. Verify error response with code -32061.
13. `testNoFocusedWidget` - hide all widgets, call cu.type. Verify error with code -32062.
14. `testIncludeScreenshot` - call cu.click with include_screenshot:true. Verify response has both "success":true and "screenshot" key.

Add to tests/CMakeLists.txt: new test executable `test_computer_use_api` linking qtmcp_probe, Qt::Core, Qt::Test, Qt::Widgets. Register with add_test. Set QTMCP_ENABLED=0 env var.
  </action>
  <verify>
`cmake --build build/ --target test_computer_use_api` succeeds.
`ctest --test-dir build/ -R test_computer_use_api --output-on-failure` passes all tests.
`ctest --test-dir build/ --output-on-failure` - ALL tests pass (no regressions).
  </verify>
  <done>
14+ integration tests covering all 10 CU requirements plus error handling. cu.screenshot returns valid PNG. cu.click triggers buttons. cu.type enters text. cu.key handles Chrome key names. cu.scroll sends events. cu.cursorPosition returns coordinates. OOB and no-focus errors returned correctly. All tests pass alongside existing test suite.
  </done>
</task>

</tasks>

<verification>
- `ctest --test-dir build/ --output-on-failure` passes ALL tests (old + new)
- test_key_name_mapper covers resolve + parseKeyCombo thoroughly
- test_computer_use_api covers all 13 cu.* methods
- Error cases tested (OOB, no focus, no window)
- No regressions in existing 8 test suites
</verification>

<success_criteria>
- test_key_name_mapper.cpp exists with 10+ test functions, all passing
- test_computer_use_api.cpp exists with 14+ test functions, all passing
- All 10 existing test suites still pass
- Total test count: 10+ test suites, covering all CU-01 through CU-10 requirements
</success_criteria>

<output>
After completion, create `.planning/phases/04-computer-use-mode/04-03-SUMMARY.md`
</output>
