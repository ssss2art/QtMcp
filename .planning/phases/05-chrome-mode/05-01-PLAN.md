---
phase: 05-chrome-mode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/probe/accessibility/role_mapper.h
  - src/probe/accessibility/role_mapper.cpp
  - src/probe/accessibility/console_message_capture.h
  - src/probe/accessibility/console_message_capture.cpp
  - src/probe/accessibility/accessibility_tree_walker.h
  - src/probe/accessibility/accessibility_tree_walker.cpp
  - src/probe/api/error_codes.h
autonomous: true

must_haves:
  truths:
    - "RoleMapper translates QAccessible::Role to Chrome/ARIA role strings"
    - "RoleMapper identifies interactive vs structural roles"
    - "ConsoleMessageCapture intercepts qDebug/qWarning/qCritical/qFatal messages into a ring buffer"
    - "ConsoleMessageCapture chains to previous message handler (does not swallow messages)"
    - "AccessibilityTreeWalker produces JSON tree with ref_N identifiers for interactive elements"
    - "AccessibilityTreeWalker respects maxDepth, maxChars, filter, and scopeRef options"
  artifacts:
    - path: "src/probe/accessibility/role_mapper.h"
      provides: "QAccessible::Role to Chrome role name mapping"
      contains: "toChromeName"
    - path: "src/probe/accessibility/role_mapper.cpp"
      provides: "Static QHash lookup table with ~55 role mappings"
      contains: "s_roleMap"
    - path: "src/probe/accessibility/console_message_capture.h"
      provides: "ConsoleMessage struct and ConsoleMessageCapture singleton"
      contains: "qInstallMessageHandler"
    - path: "src/probe/accessibility/console_message_capture.cpp"
      provides: "Ring buffer message handler with thread-safe access"
      contains: "messageHandler"
    - path: "src/probe/accessibility/accessibility_tree_walker.h"
      provides: "WalkOptions, WalkResult structs and static walk() method"
      contains: "AccessibilityTreeWalker"
    - path: "src/probe/accessibility/accessibility_tree_walker.cpp"
      provides: "Recursive tree traversal with ref assignment and JSON output"
      contains: "walkNode"
    - path: "src/probe/api/error_codes.h"
      provides: "Chrome Mode error codes -32070 to -32076"
      contains: "kRefNotFound"
  key_links:
    - from: "accessibility_tree_walker.cpp"
      to: "role_mapper.h"
      via: "RoleMapper::toChromeName() and RoleMapper::isInteractive()"
      pattern: "RoleMapper::toChromeName"
    - from: "accessibility_tree_walker.cpp"
      to: "core/object_registry.h"
      via: "ObjectRegistry::instance()->objectId() for Qt extras"
      pattern: "ObjectRegistry.*objectId"
    - from: "console_message_capture.cpp"
      to: "qInstallMessageHandler"
      via: "Qt message handler API"
      pattern: "qInstallMessageHandler"
---

<objective>
Create the three infrastructure classes needed by Chrome Mode: RoleMapper (QAccessible::Role to Chrome/ARIA name lookup), ConsoleMessageCapture (qDebug interception), and AccessibilityTreeWalker (recursive tree traversal with ref assignment). Also add Chrome Mode error codes to error_codes.h.

Purpose: These utilities are the foundation that ChromeModeApi will call. Separating them from the API class keeps the codebase modular and testable.
Output: Three new source/header pairs in src/probe/accessibility/, updated error_codes.h
</objective>

<execution_context>
@C:\Users\stjohnson\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\stjohnson\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-chrome-mode/05-RESEARCH.md
@.planning/phases/05-chrome-mode/05-CONTEXT.md
@src/probe/api/error_codes.h
@src/probe/core/object_registry.h
@src/probe/api/response_envelope.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: RoleMapper and ConsoleMessageCapture utility classes</name>
  <files>
    src/probe/accessibility/role_mapper.h
    src/probe/accessibility/role_mapper.cpp
    src/probe/accessibility/console_message_capture.h
    src/probe/accessibility/console_message_capture.cpp
    src/probe/api/error_codes.h
  </files>
  <action>
Create the `src/probe/accessibility/` directory.

**RoleMapper** (role_mapper.h/cpp):
- Static utility class in `qtmcp` namespace (no QObject needed, purely static)
- `static QString toChromeName(QAccessible::Role role)` - returns Chrome/ARIA role name string
- `static bool isInteractive(QAccessible::Role role)` - returns true for interactive roles
- Implementation uses file-scope static `QHash<QAccessible::Role, QString> s_roleMap` with ~55 entries from RESEARCH.md mapping table
- File-scope static `QSet<QAccessible::Role> s_interactiveRoles` with entries: Button, CheckBox, RadioButton, ComboBox, SpinBox, Slider, Dial, EditableText, Link, MenuItem, PageTab, ListItem, TreeItem, Cell, ButtonMenu, ButtonDropDown, ScrollBar, HotkeyField
- Unknown roles return `QStringLiteral("generic")` as fallback
- Include `<QAccessible>` for role enum

**ConsoleMessageCapture** (console_message_capture.h/cpp):
- Singleton class using Q_GLOBAL_STATIC pattern (consistent with ObjectRegistry, SignalMonitor)
- `ConsoleMessage` struct with: QtMsgType type, QString message, QString file, int line, QString function, qint64 timestamp
- `static ConsoleMessageCapture* instance()` via Q_GLOBAL_STATIC
- `void install()` - calls qInstallMessageHandler(), saves previous handler in m_previousHandler
- `QList<ConsoleMessage> messages(const QString& pattern, bool onlyErrors, int limit) const` - filtered retrieval; pattern is regex matched against message text; onlyErrors filters to QtWarningMsg/QtCriticalMsg/QtFatalMsg
- `void clear()` - clears the ring buffer
- Ring buffer with MAX_MESSAGES = 1000
- Thread-safe with QMutex (m_mutex) guarding m_messages
- Static messageHandler function chains to m_previousHandler after recording (never swallow messages)
- Use QRegularExpression for pattern matching in messages()

**Error codes** - Add to error_codes.h:
```cpp
// Chrome Mode errors (-32070 to -32079)
constexpr int kRefNotFound = -32070;
constexpr int kRefStale = -32071;
constexpr int kFormInputUnsupported = -32072;
constexpr int kTreeTooLarge = -32073;
constexpr int kFindTooManyResults = -32074;
constexpr int kNavigateInvalid = -32075;
constexpr int kConsoleNotAvailable = -32076;
```
  </action>
  <verify>
Files exist: `ls src/probe/accessibility/role_mapper.h src/probe/accessibility/role_mapper.cpp src/probe/accessibility/console_message_capture.h src/probe/accessibility/console_message_capture.cpp`
Error codes added: `grep -c "kRefNotFound" src/probe/api/error_codes.h` returns 1
Build compiles (deferred to Task 2 which updates CMakeLists.txt)
  </verify>
  <done>
RoleMapper maps ~55 QAccessible roles to Chrome names with isInteractive() helper.
ConsoleMessageCapture singleton intercepts Qt messages into thread-safe ring buffer with regex pattern filtering.
Chrome Mode error codes -32070 to -32076 defined in error_codes.h.
  </done>
</task>

<task type="auto">
  <name>Task 2: AccessibilityTreeWalker with ref assignment and JSON output</name>
  <files>
    src/probe/accessibility/accessibility_tree_walker.h
    src/probe/accessibility/accessibility_tree_walker.cpp
  </files>
  <action>
**AccessibilityTreeWalker** (accessibility_tree_walker.h/cpp):
- Static utility class in `qtmcp` namespace
- Public structs:
  - `WalkOptions`: QString filter ("interactive"|"all", default "all"), int maxDepth (default 15), int maxChars (default 50000), QString scopeRef (empty = whole window)
  - `WalkResult`: QJsonObject tree, QHash&lt;QString, QAccessibleInterface*&gt; refMap, int totalNodes, bool truncated

- Public static method:
  - `static WalkResult walk(QWidget* rootWidget, const WalkOptions& opts)`
    - Calls `QAccessible::queryAccessibleInterface(rootWidget)` to get root interface
    - If scopeRef is provided, resolves it against a previously stored refMap (or returns error)
    - Calls private `walkNode()` recursively
    - Returns WalkResult with tree JSON and ref map

- Private static method:
  - `walkNode(QAccessibleInterface* iface, int depth, const WalkOptions& opts, int& refCounter, QHash<QString, QAccessibleInterface*>& refMap, int& charCount, bool& truncated)`
    - Guard: return empty if !iface || !iface->isValid() || depth > opts.maxDepth
    - Skip invisible elements unless filter is "all"
    - Get role via `iface->role()`, check `RoleMapper::isInteractive(role)`
    - Assign ref (ref_1, ref_2, ...) to ALL elements in "all" mode, only interactive elements in "interactive" mode. Include structural parents without refs in "interactive" mode for context.
    - Build QJsonObject node with:
      - "ref" (if assigned)
      - "role": RoleMapper::toChromeName(role)
      - "name": iface->text(QAccessible::Name) â€” fall back to objectName(), then className() if empty
      - "states": QJsonObject with focused, disabled, checked, expanded, selected, readonly, pressed, hasPopup, modal, editable, multiline, password, required (only include if true; for expanded/collapsed use expanded:true/false)
      - "bounds": {x, y, width, height} from iface->rect() (only if valid)
      - Qt extras from iface->object(): "objectName", "className", "objectId" (from ObjectRegistry)
    - Recurse into children: `iface->childCount()` / `iface->child(i)`
    - Track charCount (approximate JSON size by adding string lengths), stop and set truncated=true if exceeding maxChars
    - Add children array only if non-empty

- Important: Call `QAccessible::setActive(true)` at the start of walk() to ensure accessibility is initialized.
- Important: For name fallback order: iface->text(QAccessible::Name), then obj->objectName(), then obj->metaObject()->className()
  </action>
  <verify>
Files exist: `ls src/probe/accessibility/accessibility_tree_walker.h src/probe/accessibility/accessibility_tree_walker.cpp`
Build compiles after CMakeLists.txt is updated in Plan 05-02
  </verify>
  <done>
AccessibilityTreeWalker.walk() produces nested JSON tree with ref_N identifiers.
Supports "interactive" and "all" filter modes.
Respects maxDepth, maxChars limits with truncation flag.
Includes Chrome-compatible role names, states, bounds, and Qt extras per node.
Name fallback chain prevents empty-name nodes.
  </done>
</task>

</tasks>

<verification>
- All 6 new files (3 .h + 3 .cpp) exist in src/probe/accessibility/
- error_codes.h contains 7 new Chrome Mode error codes
- RoleMapper covers all roles from research mapping table
- ConsoleMessageCapture chains to previous handler
- AccessibilityTreeWalker produces nested JSON with ref assignments
- No build verification yet (CMakeLists.txt updated in Plan 05-02)
</verification>

<success_criteria>
- RoleMapper::toChromeName() maps ~55 Qt roles to Chrome/ARIA names
- RoleMapper::isInteractive() identifies ~18 interactive roles
- ConsoleMessageCapture intercepts messages with regex filtering and ring buffer
- AccessibilityTreeWalker walks QAccessible tree producing ref-annotated JSON
- Chrome Mode error codes defined in -32070 to -32076 range
</success_criteria>

<output>
After completion, create `.planning/phases/05-chrome-mode/05-01-SUMMARY.md`
</output>
