---
phase: 06-extended-introspection
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/probe/introspection/model_navigator.h
  - src/probe/introspection/model_navigator.cpp
autonomous: true

must_haves:
  truths:
    - "ModelNavigator can discover all QAbstractItemModel instances via ObjectRegistry"
    - "ModelNavigator resolves view objectIds to their underlying model automatically"
    - "Model data retrieval uses smart pagination (all rows if <100, first 100 otherwise)"
    - "Model data returns Qt::DisplayRole by default, supports specific role requests"
    - "Role resolution supports both role name strings and integer role IDs"
    - "Tree model navigation works via parent index specification"
  artifacts:
    - path: "src/probe/introspection/model_navigator.h"
      provides: "ModelNavigator class with listModels(), getModelData(), getModelInfo(), resolveModel()"
    - path: "src/probe/introspection/model_navigator.cpp"
      provides: "Model discovery, data retrieval with pagination, role resolution, view-to-model resolution"
  key_links:
    - from: "src/probe/introspection/model_navigator.cpp"
      to: "src/probe/core/object_registry.h"
      via: "ObjectRegistry::instance()->allObjects() for model discovery"
      pattern: "ObjectRegistry.*allObjects"
    - from: "src/probe/introspection/model_navigator.cpp"
      to: "src/probe/introspection/variant_json.h"
      via: "variantToJson() for model data conversion"
      pattern: "variantToJson"
---

<objective>
Create the ModelNavigator utility class for QAbstractItemModel discovery, data retrieval with smart pagination, and view-to-model resolution.

Purpose: Agents need to discover models in the application, get their data with proper pagination, and navigate tree model hierarchies. This class encapsulates all model/view logic that Plan 03 will wire into NativeModeApi.

Output: model_navigator.h/.cpp with complete model introspection API.
</objective>

<execution_context>
@C:\Users\stjohnson\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\stjohnson\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-extended-introspection/06-CONTEXT.md
@.planning/phases/06-extended-introspection/06-RESEARCH.md
@src/probe/core/object_registry.h
@src/probe/introspection/variant_json.h
@src/probe/api/error_codes.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: ModelNavigator Header and Implementation</name>
  <files>
    src/probe/introspection/model_navigator.h
    src/probe/introspection/model_navigator.cpp
  </files>
  <action>
    **src/probe/introspection/model_navigator.h:** Create with `namespace qtmcp`:

    ```
    class ModelNavigator {
    public:
        // Model discovery — iterate ObjectRegistry, cast to QAbstractItemModel*
        static QJsonArray listModels();

        // Model info — rowCount, columnCount, roleNames for a specific model
        static QJsonObject getModelInfo(QAbstractItemModel* model);

        // Model data with smart pagination
        // - offset/limit for pagination (limit <= 0 means auto: all if <100 rows, else 100)
        // - roles: list of role IDs to fetch (empty = Qt::DisplayRole only)
        // - parentRow/parentCol: for tree model navigation (-1 = root)
        static QJsonObject getModelData(QAbstractItemModel* model,
                                         int offset = 0, int limit = -1,
                                         const QList<int>& roles = {},
                                         int parentRow = -1, int parentCol = 0);

        // Resolve objectId to QAbstractItemModel* — handles both model and view objectIds
        // Tries: qobject_cast<QAbstractItemModel*>, QAbstractItemView::model(), property("model")
        static QAbstractItemModel* resolveModel(QObject* obj);

        // Role name resolution — resolve role name string to int role ID
        // Checks model->roleNames() first, then standard Qt roles
        static int resolveRoleName(QAbstractItemModel* model, const QString& roleName);

        // Get role names map as JSON — {roleId: roleName, ...}
        static QJsonObject getRoleNames(QAbstractItemModel* model);
    };
    ```

    No QObject inheritance needed — purely static utility class (same pattern as RoleMapper in Chrome Mode).

    **src/probe/introspection/model_navigator.cpp:** Implement:

    1. `listModels()`: Iterate `ObjectRegistry::instance()->allObjects()`, try `qobject_cast<QAbstractItemModel*>(obj)` on each. For each model found, build JSON object with:
       - objectId (from ObjectRegistry::instance()->objectId(obj))
       - className (from metaObject()->className())
       - rowCount (model->rowCount())
       - columnCount (model->columnCount())
       - roleNames (via getRoleNames())
       Skip internal Qt models (className starts with "Q" AND has "Internal" in name — use heuristic, not blocklist).

    2. `getModelInfo()`: Return JSON with rowCount, columnCount, roleNames, hasChildren(QModelIndex()), className.

    3. `getModelData()`: Implement smart pagination per CONTEXT.md:
       - Build parent QModelIndex from parentRow/parentCol if parentRow >= 0
       - Get totalRows = model->rowCount(parentIdx), totalCols = model->columnCount(parentIdx)
       - If limit <= 0 and totalRows <= 100: offset=0, limit=totalRows (return all)
       - If limit <= 0 and totalRows > 100: limit=100 (first page)
       - Clamp offset to [0, totalRows), endRow = min(offset+limit, totalRows)
       - If roles is empty, default to {Qt::DisplayRole}
       - For each row in [offset, endRow), for each column, for each role:
         - Create QModelIndex via model->index(row, col, parentIdx)
         - Call model->data(idx, role) and convert via variantToJson()
       - Build JSON: { rows: [...], totalRows, totalColumns, offset, limit, hasMore: (endRow < totalRows) }
       - Each row is a JSON array of cells, each cell is { roleName: value, ... }
       - Also include hasChildren for each row (for tree model navigation)

    4. `resolveModel()`: Try in order:
       - qobject_cast<QAbstractItemModel*>(obj) — direct model
       - qobject_cast<QAbstractItemView*>(obj) — widget view, call view->model()
       - obj->property("model") — QML view fallback, try QObject* extraction and cast
       - return nullptr if all fail
       Include `<QAbstractItemView>` from QtWidgets.

    5. `resolveRoleName()`: Check model->roleNames() hash for matching name, then check static standard roles table (display, edit, decoration, toolTip, statusTip, whatsThis, font, textAlignment, background, foreground, checkState, sizeHint). Return -1 if not found.

    6. `getRoleNames()`: Convert model->roleNames() QHash<int,QByteArray> to QJsonObject with string keys (role ID as string) and string values (role name).

    Include: `<QAbstractItemModel>`, `<QAbstractItemView>`, `<QJsonArray>`, `<QJsonObject>` and existing project headers for ObjectRegistry, variant_json.
  </action>
  <verify>
    Build with `cmake --build build/ --config Debug 2>&1`. Must compile with zero errors. Run `ctest --test-dir build/ --output-on-failure -C Debug` — all 11 existing test suites pass.
  </verify>
  <done>
    model_navigator.h/.cpp compile cleanly. ModelNavigator provides listModels(), getModelData() with smart pagination, resolveModel() for view-to-model resolution, and resolveRoleName() for role name lookup. All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ModelNavigator to CMake Build</name>
  <files>
    src/probe/CMakeLists.txt
  </files>
  <action>
    Add `introspection/model_navigator.cpp` to PROBE_SOURCES and `introspection/model_navigator.h` to PROBE_HEADERS in src/probe/CMakeLists.txt.

    NOTE: If Plan 06-01 has already been executed and added qml_inspector files, do NOT re-add those. Only add model_navigator files. If Plan 06-01 has NOT run yet, add both model_navigator files now.
  </action>
  <verify>
    Build with `cmake --build build/ --config Debug 2>&1`. Must compile cleanly. All 11 existing tests pass.
  </verify>
  <done>
    model_navigator.cpp/.h listed in CMakeLists.txt and compiled into qtmcp_probe shared library.
  </done>
</task>

</tasks>

<verification>
1. `cmake --build build/ --config Debug` compiles cleanly
2. `ctest --test-dir build/ --output-on-failure -C Debug` — all 11 existing test suites pass
3. `grep "model_navigator" src/probe/CMakeLists.txt` shows files in build
4. model_navigator.h exposes listModels, getModelData, getModelInfo, resolveModel, resolveRoleName, getRoleNames
</verification>

<success_criteria>
- ModelNavigator compiles and links into qtmcp_probe
- listModels() discovers QAbstractItemModel instances via ObjectRegistry
- getModelData() implements smart pagination (all if <100 rows, paginated otherwise)
- resolveModel() handles model objects, widget views (QAbstractItemView), and QML views (property("model"))
- resolveRoleName() resolves both custom and standard Qt role names
- All 11 existing test suites pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/06-extended-introspection/06-02-SUMMARY.md`
</output>
