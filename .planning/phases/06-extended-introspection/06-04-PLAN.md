---
phase: 06-extended-introspection
plan: 04
type: execute
wave: 3
depends_on: ["06-03"]
files_modified:
  - tests/test_model_navigator.cpp
  - tests/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "qt.models.list discovers QAbstractItemModel instances in the application"
    - "qt.models.info returns rowCount, columnCount, roleNames for a model"
    - "qt.models.data returns paginated data with smart pagination (all if <100, paginated otherwise)"
    - "qt.models.data supports role filtering by name and by integer ID"
    - "qt.models.* auto-resolves view objectIds to their model"
    - "qt.qml.inspect returns isQmlItem:false for non-QML objects (QML-specific behavior untestable without Qt Quick runtime)"
    - "Error handling: invalid objectId, not-a-model, out-of-bounds offset, unknown role name"
    - "All 12+ test suites pass with zero regressions"
  artifacts:
    - path: "tests/test_model_navigator.cpp"
      provides: "Integration tests for qt.models.* and qt.qml.inspect methods via JsonRpcHandler"
    - path: "tests/CMakeLists.txt"
      provides: "test_model_navigator target with proper linking and environment"
  key_links:
    - from: "tests/test_model_navigator.cpp"
      to: "src/probe/api/native_mode_api.h"
      via: "NativeModeApi registered on test JsonRpcHandler"
      pattern: "NativeModeApi"
    - from: "tests/test_model_navigator.cpp"
      to: "src/probe/introspection/model_navigator.h"
      via: "ModelNavigator tested via JSON-RPC methods"
      pattern: "qt\\.models"
---

<objective>
Create integration tests for Model/View and QML introspection API methods.

Purpose: Verify that qt.models.* and qt.qml.inspect methods work correctly end-to-end through the JSON-RPC handler, with proper error handling and response formatting.

Output: test_model_navigator.cpp with comprehensive tests, added to CMake test suite.
</objective>

<execution_context>
@C:\Users\stjohnson\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\stjohnson\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-extended-introspection/06-CONTEXT.md
@.planning/phases/06-extended-introspection/06-01-SUMMARY.md
@.planning/phases/06-extended-introspection/06-02-SUMMARY.md
@.planning/phases/06-extended-introspection/06-03-SUMMARY.md
@tests/test_native_mode_api.cpp
@tests/CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Model/View and QML Integration Tests</name>
  <files>
    tests/test_model_navigator.cpp
    tests/CMakeLists.txt
  </files>
  <action>
    **tests/test_model_navigator.cpp:** Create test class following existing patterns (see test_native_mode_api.cpp for the pattern):

    Setup: In init() create fresh JsonRpcHandler + NativeModeApi + test QStandardItemModel + QTableView. Cleanup in cleanup().

    Create a QStandardItemModel with known data:
    - 3 rows x 2 columns with string data (e.g., "A1", "A2", "B1", "B2", "C1", "C2")
    - Set column headers
    - Register in ObjectRegistry with objectName "testModel"
    - Create a QTableView with objectName "testView", set its model to the QStandardItemModel

    Also create a large model (150 rows) for pagination tests.

    **Test cases (target: 15-20 tests):**

    qt.models.list:
    - `testModelsListFindsTestModel` — call qt.models.list, verify testModel appears in result array with correct className, rowCount, columnCount
    - `testModelsListIncludesRoleNames` — verify roleNames object is present

    qt.models.info:
    - `testModelsInfoByModelId` — call qt.models.info with model's objectId, verify rowCount=3, columnCount=2
    - `testModelsInfoByViewId` — call qt.models.info with VIEW's objectId, verify it auto-resolves to model and returns same data
    - `testModelsInfoInvalidId` — call with bad objectId, verify error response

    qt.models.data:
    - `testModelsDataSmallModel` — call qt.models.data on 3-row model with no offset/limit, verify all 3 rows returned, hasMore=false
    - `testModelsDataDisplayRole` — verify default data uses DisplayRole, values match "A1", "B1", "C1" etc.
    - `testModelsDataWithOffset` — call with offset=1, limit=1, verify only row 1 returned, hasMore=true
    - `testModelsDataSmartPaginationLargeModel` — call qt.models.data on 150-row model with no limit, verify limit=100, hasMore=true, totalRows=150
    - `testModelsDataByRoleName` — call with roles=["display"], verify data returned
    - `testModelsDataByRoleId` — call with roles=[0] (DisplayRole), verify data returned
    - `testModelsDataInvalidRole` — call with roles=["nonexistent"], verify error response
    - `testModelsDataOutOfBounds` — call with offset=999 on 3-row model, verify error or empty result
    - `testModelsDataNotAModel` — call qt.models.data with objectId of a plain QObject (not model or view), verify kNotAModel error

    qt.qml.inspect:
    - `testQmlInspectNonQmlObject` — call qt.qml.inspect with a plain QWidget, verify isQmlItem=false (no error, just info)
    - `testQmlInspectInvalidId` — call with bad objectId, verify error

    Response format:
    - `testResponseEnvelopeWrapping` — verify all responses have "result" and "meta" keys (ResponseEnvelope format)

    **Helper:** Create a helper method `callMethod(methodName, params)` that dispatches to JsonRpcHandler and returns the parsed QJsonObject response. Same pattern used in test_native_mode_api.cpp.

    **tests/CMakeLists.txt:** Add test_model_navigator target following exact same pattern as test_chrome_mode_api (link qtmcp_probe, Qt6::Core, Qt6::Gui, Qt6::Widgets, Qt6::Test; include src/probe; set QTMCP_ENABLED=0 and QT_QPA_PLATFORM=minimal env vars; copy Qt Test DLL on Windows).
  </action>
  <verify>
    Build: `cmake --build build/ --config Debug 2>&1`
    Run new test: `ctest --test-dir build/ -R test_model_navigator --output-on-failure -C Debug`
    Run all tests: `ctest --test-dir build/ --output-on-failure -C Debug` — all 12 test suites pass (11 existing + 1 new).
  </verify>
  <done>
    15+ integration tests verify qt.models.list, qt.models.info, qt.models.data, and qt.qml.inspect. Tests cover happy path, pagination, view-to-model resolution, error cases. All 12 test suites pass with zero regressions.
  </done>
</task>

</tasks>

<verification>
1. `cmake --build build/ --config Debug` compiles cleanly
2. `ctest --test-dir build/ -R test_model_navigator --output-on-failure -C Debug` — new test suite passes
3. `ctest --test-dir build/ --output-on-failure -C Debug` — all 12 test suites pass
4. Test covers: model discovery, model info, paginated data, role filtering, view-to-model resolution, QML inspect on non-QML objects, error cases
</verification>

<success_criteria>
- 15+ test functions covering all qt.models.* and qt.qml.inspect methods
- Smart pagination verified: small model returns all, large model returns first 100
- View-to-model auto-resolution tested
- Error handling tested: invalid objectId, not-a-model, out-of-bounds, unknown role
- Response envelope format verified on all responses
- All 12 test suites (11 existing + 1 new) pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/06-extended-introspection/06-04-SUMMARY.md`
</output>
