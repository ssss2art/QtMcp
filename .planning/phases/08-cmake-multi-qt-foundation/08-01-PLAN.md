---
phase: 08-cmake-multi-qt-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - CMakeLists.txt
  - src/probe/CMakeLists.txt
  - src/launcher/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "Building against Qt 5.15 produces a file named qtmcp-probe-qt5.15.dll (Windows) or libqtmcp-probe-qt5.15.so (Linux)"
    - "Building against Qt 6.8 produces a file named qtmcp-probe-qt6.8.dll (Windows) or libqtmcp-probe-qt6.8.so (Linux)"
    - "Debug builds produce qtmcp-probe-qt6.8d.dll / libqtmcp-probe-qt6.8d.so"
    - "cmake --install produces artifacts in versioned subdirectories under lib/qtmcp/qtX.Y/"
    - "QTMCP_QT_DIR hint takes precedence over CMAKE_PREFIX_PATH for Qt detection"
  artifacts:
    - path: "CMakeLists.txt"
      provides: "Root build config with QTMCP_QT_DIR support and versioned install layout"
      contains: "QTMCP_QT_DIR"
    - path: "src/probe/CMakeLists.txt"
      provides: "Probe library with Qt-version-encoded OUTPUT_NAME and debug suffix"
      contains: "qtmcp-probe-qt"
    - path: "src/launcher/CMakeLists.txt"
      provides: "Launcher with versioned output name"
      contains: "qtmcp-launch-qt"
  key_links:
    - from: "CMakeLists.txt"
      to: "src/probe/CMakeLists.txt"
      via: "QTMCP_QT_VERSION_TAG variable propagation"
      pattern: "QTMCP_QT_VERSION_TAG"
    - from: "CMakeLists.txt"
      to: "install targets"
      via: "versioned install destinations"
      pattern: "lib/qtmcp/qt"
---

<objective>
Rework the CMake build system so that artifact filenames encode the Qt major.minor version and install targets use versioned subdirectories. Add QTMCP_QT_DIR hint for explicit Qt path override.

Purpose: BUILD-01 and BUILD-03 require versioned, relocatable artifacts. This plan produces the correct filenames and install layout that Phase 9 CI and Phase 12 vcpkg will depend on.

Output: Modified CMakeLists.txt files that produce `qtmcp-probe-qt{major}.{minor}[d].{ext}` and install to `lib/qtmcp/qt{major}.{minor}/`.
</objective>

<execution_context>
@C:\Users\stjohnson\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\stjohnson\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-cmake-multi-qt-foundation/08-CONTEXT.md
@CMakeLists.txt
@src/probe/CMakeLists.txt
@src/launcher/CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add QTMCP_QT_DIR hint and compute version tag variables</name>
  <files>CMakeLists.txt</files>
  <action>
Modify the root CMakeLists.txt Qt detection section (lines ~38-88) to:

1. Add a cache option BEFORE find_package calls:
   ```cmake
   set(QTMCP_QT_DIR "" CACHE PATH "Explicit path to Qt installation (takes precedence over CMAKE_PREFIX_PATH)")
   ```

2. If QTMCP_QT_DIR is set, prepend it to CMAKE_PREFIX_PATH so it takes priority:
   ```cmake
   if(QTMCP_QT_DIR)
       list(PREPEND CMAKE_PREFIX_PATH "${QTMCP_QT_DIR}")
       message(STATUS "Using Qt hint: ${QTMCP_QT_DIR}")
   endif()
   ```

3. After Qt is found (after the if/else block that sets QT_VERSION), add a fatal error if neither Qt5 nor Qt6 was found. Currently Qt5 uses REQUIRED so this is partially covered, but make the error message explicit:
   ```cmake
   if(NOT Qt6_FOUND AND NOT Qt5_FOUND)
       message(FATAL_ERROR "No Qt installation found. Set CMAKE_PREFIX_PATH or -DQTMCP_QT_DIR=<path>")
   endif()
   ```

4. Extract Qt major.minor into a reusable variable:
   ```cmake
   string(REGEX MATCH "^([0-9]+)\\.([0-9]+)" _qt_major_minor "${QT_VERSION}")
   set(QTMCP_QT_VERSION_TAG "qt${_qt_major_minor}" CACHE INTERNAL "Qt version tag for artifact naming")
   ```
   This produces values like `qt5.15` or `qt6.8`.

5. Compute the versioned install subdirectory:
   ```cmake
   set(QTMCP_INSTALL_LIBDIR "lib/qtmcp/${QTMCP_QT_VERSION_TAG}" CACHE INTERNAL "Versioned library install directory")
   ```

6. Update the install() calls at the bottom of CMakeLists.txt:
   - Change probe install from `LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}` to `LIBRARY DESTINATION ${QTMCP_INSTALL_LIBDIR}`
   - Same for ARCHIVE and RUNTIME destinations: use `${QTMCP_INSTALL_LIBDIR}` for LIBRARY/ARCHIVE, and `bin/qtmcp/${QTMCP_QT_VERSION_TAG}` for RUNTIME (Windows DLLs)
   - Change header install to: `DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/qtmcp`  (headers are NOT versioned by Qt version - same API regardless of Qt)
   - Change cmake config install to: `DESTINATION share/cmake/QtMCP` (use share/ not lib/cmake/ since lib/ is now versioned)
   - Update the EXPORT install destination to match: `DESTINATION share/cmake/QtMCP`
   - Update configure_package_config_file INSTALL_DESTINATION to `share/cmake/QtMCP`

7. Add the Qt version tag to the configuration summary message block.

Do NOT change the Qt detection logic itself (the find_package calls and QML optional checks). Only add the hint mechanism and version tag computation.
  </action>
  <verify>
Run `cmake -B build_test -DQTMCP_BUILD_TESTS=OFF -DQTMCP_BUILD_TEST_APP=OFF` from the project root. Verify:
- Configure output shows `QTMCP_QT_VERSION_TAG` in summary
- No CMake errors
- If Qt6 is installed, tag should be something like `qt6.x`
  </verify>
  <done>
CMakeLists.txt has QTMCP_QT_DIR option, computes QTMCP_QT_VERSION_TAG, and install targets use versioned subdirectories. Configure succeeds with no errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply versioned OUTPUT_NAME with debug suffix to probe and launcher</name>
  <files>src/probe/CMakeLists.txt, src/launcher/CMakeLists.txt</files>
  <action>
**src/probe/CMakeLists.txt:**

1. Change the OUTPUT_NAME property from `"qtmcp-probe"` to use the version tag:
   ```cmake
   set_target_properties(qtmcp_probe PROPERTIES
       VERSION ${PROJECT_VERSION}
       SOVERSION ${PROJECT_VERSION_MAJOR}
       OUTPUT_NAME "qtmcp-probe-${QTMCP_QT_VERSION_TAG}"
       EXPORT_NAME Probe
   )
   ```
   Note: Also capitalize EXPORT_NAME to `Probe` (capital P) so the exported target becomes `QtMCP::Probe` matching the CONTEXT.md decision.

2. Add debug suffix using CMake's built-in DEBUG_POSTFIX:
   ```cmake
   set_target_properties(qtmcp_probe PROPERTIES
       DEBUG_POSTFIX "d"
   )
   ```
   This produces:
   - Release: `qtmcp-probe-qt6.8.dll` / `libqtmcp-probe-qt6.8.so`
   - Debug: `qtmcp-probe-qt6.8d.dll` / `libqtmcp-probe-qt6.8d.so`

3. Update the ALIAS target from `QtMCP::probe` to `QtMCP::Probe` (capital P, matching export name):
   ```cmake
   add_library(QtMCP::Probe ALIAS qtmcp_probe)
   ```

**src/launcher/CMakeLists.txt:**

1. Change OUTPUT_NAME to include version tag:
   ```cmake
   set_target_properties(qtmcp_launcher PROPERTIES
       OUTPUT_NAME "qtmcp-launch-${QTMCP_QT_VERSION_TAG}"
   )
   ```

2. Add DEBUG_POSTFIX:
   ```cmake
   set_target_properties(qtmcp_launcher PROPERTIES
       DEBUG_POSTFIX "d"
   )
   ```

**Important:** Do NOT change any linking, include directories, compile definitions, or source file lists. Only change target properties (OUTPUT_NAME, EXPORT_NAME, DEBUG_POSTFIX) and the alias name.
  </action>
  <verify>
Run `cmake -B build_test -DQTMCP_BUILD_TESTS=OFF -DQTMCP_BUILD_TEST_APP=OFF` then `cmake --build build_test --config Release`.
- Check that the output binary in `build_test/lib/` or `build_test/bin/` has the versioned name (e.g. `qtmcp-probe-qt6.8.dll` on Windows)
- Run `cmake --build build_test --config Debug` and verify the `d` suffix appears
- Run `cmake --install build_test --prefix build_test/install --config Release` and verify artifacts land in `lib/qtmcp/qt6.x/` subdirectory
  </verify>
  <done>
Probe produces `qtmcp-probe-qt{M}.{m}[d].{ext}`, launcher produces `qtmcp-launch-qt{M}.{m}[d].{ext}`, and cmake --install places them in versioned subdirectories. Exported target name is QtMCP::Probe.
  </done>
</task>

</tasks>

<verification>
1. `cmake -B build_verify -DQTMCP_BUILD_TESTS=OFF -DQTMCP_BUILD_TEST_APP=OFF` configures without errors
2. `cmake --build build_verify --config Release` produces versioned probe DLL/SO
3. `cmake --install build_verify --prefix build_verify/install --config Release` creates:
   - `install/lib/qtmcp/qt{X}.{Y}/qtmcp-probe-qt{X}.{Y}.dll` (or .so with lib prefix)
   - `install/include/qtmcp/` (headers)
   - `install/share/cmake/QtMCP/` (CMake config files)
4. Artifact filenames match the pattern from BUILD-01
</verification>

<success_criteria>
- BUILD-01 satisfied: probe output encodes Qt version in filename
- BUILD-03 partially satisfied: install targets produce versioned, relocatable artifacts in standard layout
- QTMCP_QT_DIR hint works and takes precedence
- Debug suffix `d` is appended correctly
- Existing build (tests, test_app) still compiles against the renamed targets
</success_criteria>

<output>
After completion, create `.planning/phases/08-cmake-multi-qt-foundation/08-01-SUMMARY.md`
</output>
