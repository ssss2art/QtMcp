---
phase: 09-ci-matrix-build
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
  - vcpkg.json
  - CMakePresets.json
autonomous: true

must_haves:
  truths:
    - "Push to main triggers an 8-cell matrix build (4 Qt versions x 2 platforms)"
    - "Each matrix cell produces uploadable probe artifacts"
    - "fail-fast is disabled so all cells run to completion"
    - "Qt is installed via jurplel/install-qt-action@v4 with correct runner per Qt version"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "Matrix build workflow with 8 cells"
      contains: "strategy:"
    - path: "vcpkg.json"
      provides: "CI-compatible vcpkg manifest (Qt deps not pulled by vcpkg in CI)"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "CMakePresets.json"
      via: "cmake --preset ci-linux / ci-windows"
      pattern: "--preset ci-(linux|windows)"
    - from: ".github/workflows/ci.yml"
      to: "jurplel/install-qt-action@v4"
      via: "Qt version from matrix variable"
      pattern: "install-qt-action@v4"
---

<objective>
Write the complete GitHub Actions matrix CI workflow that builds the QtMCP probe for 4 Qt versions (5.15, 6.2, 6.8, 6.9) on 2 platforms (Windows MSVC, Linux GCC) — 8 matrix cells total.

Purpose: Every push validates the probe builds cleanly across the full Qt version matrix, catching compatibility regressions early.
Output: `.github/workflows/ci.yml` with matrix build job, plus vcpkg.json update to avoid building Qt from source in CI.
</objective>

<execution_context>
@C:\Users\stjohnson\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\stjohnson\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ci-matrix-build/09-CONTEXT.md
@.planning/phases/08-cmake-multi-qt-foundation/08-01-SUMMARY.md
@.planning/phases/08-cmake-multi-qt-foundation/08-02-SUMMARY.md
@CMakeLists.txt
@CMakePresets.json
@vcpkg.json
@.github/workflows/ci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update vcpkg.json for CI compatibility</name>
  <files>vcpkg.json</files>
  <action>
The current vcpkg.json lists `qtbase` and `qtwebsockets` as top-level dependencies. In CI, Qt is installed via `jurplel/install-qt-action`, NOT vcpkg. If vcpkg manifest mode tries to build Qt from source, it wastes 30+ minutes per cell.

Fix: Move `qtbase` and `qtwebsockets` from top-level `dependencies` into a new feature called `qt` (or remove them from default dependencies). The CI workflow will use `--x-feature=extras` to install only nlohmann-json and spdlog. Local developers who want vcpkg to provide Qt can use `--x-feature=qt`.

Updated vcpkg.json structure:
```json
{
  "dependencies": [],
  "features": {
    "qt": {
      "description": "Qt dependencies (skip in CI where Qt comes from install-qt-action)",
      "dependencies": ["qtbase", "qtwebsockets"]
    },
    "extras": {
      "description": "Optional enhanced functionality",
      "dependencies": ["nlohmann-json", "spdlog"]
    },
    "tests": {
      "description": "Test dependencies",
      "dependencies": ["gtest"]
    }
  }
}
```

Keep the existing builtin-baseline, name, version, description, homepage, license fields.

IMPORTANT: Also update `VCPKG_MANIFEST_FEATURES` in CI to include only `extras` (not `qt`). The CMakePresets vcpkg-base preset uses `CMAKE_TOOLCHAIN_FILE` which triggers manifest mode. We need to set `VCPKG_MANIFEST_FEATURES` env var to control which features are installed.
  </action>
  <verify>
Read vcpkg.json and confirm qtbase/qtwebsockets are under a `qt` feature, not top-level dependencies. Confirm `extras` feature still has nlohmann-json and spdlog.
  </verify>
  <done>vcpkg.json no longer forces Qt installation in manifest mode by default; Qt deps are opt-in via `--x-feature=qt`</done>
</task>

<task type="auto">
  <name>Task 2: Write the matrix CI workflow</name>
  <files>.github/workflows/ci.yml, CMakePresets.json</files>
  <action>
Replace the existing `.github/workflows/ci.yml` with a new workflow that includes:

**Triggers:**
- push to main
- pull_request targeting main
- workflow_dispatch (manual)
- Path filters: `src/**`, `CMakeLists.txt`, `cmake/**`, `.github/workflows/**`, `vcpkg.json`, `CMakePresets.json`

**Jobs:**

1. **lint** job (keep existing clang-format check, runs on ubuntu-24.04)

2. **build** job (the matrix):
   - needs: lint
   - fail-fast: false
   - Matrix strategy with include-style entries (NOT combinatorial, because runner OS varies per Qt version):
     ```yaml
     matrix:
       include:
         # Qt 5.15 — Ubuntu 22.04 (older OS needed)
         - qt_version: "5.15.2"
           qt_major: 5
           os: ubuntu-22.04
           platform: linux-gcc
           preset: ci-linux
           artifact_tag: qt5.15
           qt_modules: "qtwebsockets"
         - qt_version: "5.15.2"
           qt_major: 5
           os: windows-latest
           platform: windows-msvc
           preset: ci-windows
           artifact_tag: qt5.15
           qt_modules: "qtwebsockets"
         # Qt 6.2
         - qt_version: "6.2.4"
           qt_major: 6
           os: ubuntu-24.04
           platform: linux-gcc
           preset: ci-linux
           artifact_tag: qt6.2
           qt_modules: "qtwebsockets"
         - qt_version: "6.2.4"
           qt_major: 6
           os: windows-latest
           platform: windows-msvc
           preset: ci-windows
           artifact_tag: qt6.2
           qt_modules: "qtwebsockets"
         # Qt 6.8
         - qt_version: "6.8.0"
           qt_major: 6
           os: ubuntu-24.04
           platform: linux-gcc
           preset: ci-linux
           artifact_tag: qt6.8
           qt_modules: "qtwebsockets"
         - qt_version: "6.8.0"
           qt_major: 6
           os: windows-latest
           platform: windows-msvc
           preset: ci-windows
           artifact_tag: qt6.8
           qt_modules: "qtwebsockets"
         # Qt 6.9
         - qt_version: "6.9.0"
           qt_major: 6
           os: ubuntu-24.04
           platform: linux-gcc
           preset: ci-linux
           artifact_tag: qt6.9
           qt_modules: "qtwebsockets"
         - qt_version: "6.9.0"
           qt_major: 6
           os: windows-latest
           platform: windows-msvc
           preset: ci-windows
           artifact_tag: qt6.9
           qt_modules: "qtwebsockets"
     ```

   - Steps for each cell:
     1. `actions/checkout@v4`
     2. `jurplel/install-qt-action@v4` with `version: ${{ matrix.qt_version }}`, `modules: ${{ matrix.qt_modules }}`, `cache: true`
     3. `lukka/run-vcpkg@v11` — set env `VCPKG_MANIFEST_FEATURES: extras` to only install nlohmann-json and spdlog (NOT Qt). Use a recent vcpkg commit hash (e.g., `01f602195983451bc83e72f4214af2cbc495aa94` from early 2025 or similar stable tag).
     4. **Linux only**: `sudo apt-get update && sudo apt-get install -y libxkbcommon-dev libxcb-xinerama0 libxcb-cursor0 libxkbcommon-x11-0 libxtst-dev libx11-dev` (X11/XTest deps for the probe's X11 automation)
     5. **Configure**:
        - Linux: `cmake --preset ci-linux -DCMAKE_PREFIX_PATH=$Qt5_DIR` (for Qt5) or `$Qt6_DIR` (for Qt6). Use `${{ matrix.qt_major == 5 && env.Qt5_DIR || '' }}` pattern, or simpler: use `-DQTMCP_QT_DIR` approach. The install-qt-action sets `Qt5_DIR` or `Qt6_DIR` env vars depending on major version.
        - Windows: Same but with ci-windows preset and PowerShell syntax.
        - Recommended: Use `CMAKE_PREFIX_PATH` set to the appropriate `Qt{5,6}_DIR` env var from install-qt-action. For Qt5: `$Qt5_DIR`. For Qt6: the Qt6 dir. The install-qt-action@v4 sets the dir variable automatically based on Qt major version.
     6. **Build**: `cmake --build --preset ${{ matrix.preset }} --parallel`
     7. **Test**: `ctest --preset ${{ matrix.preset }}`
     8. **Install**: `cmake --install build/${{ matrix.preset }} --prefix install/${{ matrix.preset }}`
     9. **Verify install layout**: Check that `install/${{ matrix.preset }}/lib/qtmcp/${{ matrix.artifact_tag }}/` contains the probe binary. Fail the step if missing.
     10. **Upload artifact**: `actions/upload-artifact@v4` with:
         - `name: qtmcp-${{ matrix.artifact_tag }}-${{ matrix.platform }}`
         - path: upload the install directory contents (probe binary, import lib, launcher, PDB on Windows)
         - `retention-days: 7`
         - `if-no-files-found: error`

3. **python** job (keep existing, update runner to ubuntu-24.04)

4. **codeql** job (keep existing CodeQL analysis, update to use Qt 6.8 instead of 5.15.2 since it's a single build for analysis purposes, update runner to ubuntu-24.04)

**Key details:**
- The `Qt5_DIR` env var is set by `install-qt-action` when installing Qt5; `Qt6_DIR` when installing Qt6. Use conditional expressions to pick the right one.
- Set `VCPKG_MANIFEST_FEATURES: "extras"` as an env on the vcpkg step or globally, so vcpkg only installs nlohmann-json and spdlog.
- For Qt 6.2 specifically: the modules might need `qt5compat` or different module names. Check if `qtwebsockets` module name works for all Qt6 versions in install-qt-action. For Qt 6.x, the module should be listed if it's an add-on (WebSockets is bundled in Qt6 base, but may need explicit listing for install-qt-action).

**CMakePresets.json update:**
The ci-linux preset has no OS condition (unlike linux-debug/linux-release which have Linux-only conditions). This is correct for CI. However, verify that both ci-linux and ci-windows presets work with the vcpkg toolchain when `VCPKG_MANIFEST_FEATURES` controls which features are installed. No changes expected, but if the CI configure step fails because vcpkg tries to find qtbase, we may need to add `VCPKG_MANIFEST_NO_DEFAULT_FEATURES: ON` to the CI environment.

Set env var in workflow: `VCPKG_MANIFEST_NO_DEFAULT_FEATURES: "ON"` and `VCPKG_MANIFEST_FEATURES: "extras"` to prevent vcpkg from installing default (empty) deps and only install extras feature.
  </action>
  <verify>
1. Read `.github/workflows/ci.yml` and confirm:
   - 8 matrix entries exist (4 Qt versions x 2 platforms)
   - `fail-fast: false` is set
   - `jurplel/install-qt-action@v4` is used (v4, not v3)
   - Artifact names follow `qtmcp-{artifact_tag}-{platform}` pattern
   - Path filters are present on trigger
   - workflow_dispatch is present
   - VCPKG_MANIFEST_FEATURES or equivalent prevents Qt from being built by vcpkg
2. Validate YAML syntax: `python -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"`
  </verify>
  <done>Complete ci.yml workflow with 8 matrix cells, proper Qt installation, vcpkg for optional deps only, artifact upload, and install layout verification</done>
</task>

</tasks>

<verification>
1. `.github/workflows/ci.yml` exists and is valid YAML
2. Matrix has exactly 8 entries covering Qt 5.15, 6.2, 6.8, 6.9 on both Linux and Windows
3. fail-fast is disabled
4. Qt installed via `jurplel/install-qt-action@v4` (not v3)
5. vcpkg only installs nlohmann-json and spdlog (not Qt)
6. Artifacts uploaded with platform-encoded names matching `qtmcp-qt{M}.{m}-{platform}` pattern
7. Install layout verification step present
8. Lint, python, and codeql jobs preserved (updated as needed)
</verification>

<success_criteria>
- Workflow file passes YAML validation
- 8 matrix cells defined with correct Qt version / OS / preset combinations
- Artifact names match Phase 11's expected input format
- vcpkg.json updated so CI doesn't build Qt from source
</success_criteria>

<output>
After completion, create `.planning/phases/09-ci-matrix-build/09-01-SUMMARY.md`
</output>
