---
phase: 10-patched-qt-ci
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - .github/workflows/ci-patched-qt.yml
autonomous: true

must_haves:
  truths:
    - "A separate workflow ci-patched-qt.yml triggers on push to main (not PRs) and workflow_dispatch"
    - "The workflow builds the probe against patched Qt 5.15.1 on both Windows (MSVC) and Linux (GCC)"
    - "The workflow uses the composite action from .github/actions/build-qt/ to build and cache Qt"
    - "Each job has a 120-minute timeout and the workflow is isolated from the standard ci.yml matrix"
  artifacts:
    - path: ".github/workflows/ci-patched-qt.yml"
      provides: "CI workflow for patched Qt 5.15.1 builds on Windows and Linux"
      contains: "build-qt"
  key_links:
    - from: ".github/workflows/ci-patched-qt.yml"
      to: ".github/actions/build-qt/action.yml"
      via: "uses: ./.github/actions/build-qt"
      pattern: "actions/build-qt"
    - from: ".github/workflows/ci-patched-qt.yml"
      to: "CMakePresets.json"
      via: "cmake --preset ci-linux / ci-windows"
      pattern: "--preset ci-(linux|windows)"
    - from: ".github/workflows/ci-patched-qt.yml"
      to: ".ci/patches/5.15.1/"
      via: "patches-dir input to composite action"
      pattern: ".ci/patches/5.15.1"
---

<objective>
Write the GitHub Actions workflow that builds patched Qt 5.15.1 from source (using the composite action from plan 10-01) and then builds the QtMCP probe against it on both Windows and Linux.

Purpose: Validate that the probe builds cleanly against a custom-patched Qt 5.15.1, with aggressive caching so the Qt build step only runs when patches change. This workflow runs separately from the standard CI matrix.

Output: `.github/workflows/ci-patched-qt.yml`
</objective>

<execution_context>
@C:\Users\stjohnson\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\stjohnson\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-patched-qt-ci/10-CONTEXT.md
@.planning/phases/10-patched-qt-ci/10-RESEARCH.md
@.planning/phases/10-patched-qt-ci/10-01-SUMMARY.md
@.github/actions/build-qt/action.yml
@.github/workflows/ci.yml
@CMakePresets.json
@vcpkg.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write the patched Qt CI workflow</name>
  <files>.github/workflows/ci-patched-qt.yml</files>
  <action>
Create `.github/workflows/ci-patched-qt.yml` with the following structure:

**Workflow name:** `CI: Patched Qt 5.15.1`

**Triggers:**
```yaml
on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'CMakeLists.txt'
      - 'cmake/**'
      - '.ci/patches/**'
      - '.github/actions/build-qt/**'
      - '.github/workflows/ci-patched-qt.yml'
      - 'vcpkg.json'
      - 'CMakePresets.json'
  workflow_dispatch:
```

Note: NO pull_request trigger. This saves CI minutes since cold-cache Qt builds take 30-60 minutes.

**Jobs:**

Single `build` job with a 2-cell matrix:

```yaml
jobs:
  build:
    name: "Patched Qt 5.15.1 / ${{ matrix.platform }}"
    runs-on: ${{ matrix.os }}
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux-gcc
            preset: ci-linux
          - os: windows-2022
            platform: windows-msvc
            preset: ci-windows
```

Key: Use `windows-2022` (NOT `windows-latest`) because Qt 5.15.1 needs MSVC v142 toolset.
Key: Use `ubuntu-22.04` for Qt 5.15 compatibility (same as standard CI matrix).

**Environment variables (job-level):**
```yaml
env:
  VCPKG_MANIFEST_NO_DEFAULT_FEATURES: "ON"
  VCPKG_MANIFEST_FEATURES: "extras"
  QT_VERSION: "5.15.1"
  PATCHES_DIR: ".ci/patches/5.15.1"
```

**Steps:**

1. **Checkout** (`actions/checkout@v4`)

2. **Set up MSVC (Windows only)**: Use `ilammy/msvc-dev-cmd@v1` with:
   - `arch: x64`
   - `toolset: '14.29'` (pins MSVC v142 for Qt 5.15.1 compatibility)
   - Condition: `if: runner.os == 'Windows'`

3. **Build patched Qt**: Use the composite action:
   ```yaml
   - name: Build patched Qt ${{ env.QT_VERSION }}
     id: qt
     uses: ./.github/actions/build-qt
     with:
       qt-version: ${{ env.QT_VERSION }}
       patches-dir: ${{ env.PATCHES_DIR }}
   ```

4. **Setup vcpkg**: `lukka/run-vcpkg@v11` with same commit ID as ci.yml:
   ```yaml
   - name: Setup vcpkg
     uses: lukka/run-vcpkg@v11
     with:
       vcpkgGitCommitId: '01f602195983451bc83e72f4214af2cbc495aa94'
   ```

5. **Install X11/XTest deps (Linux only)**: Same packages as ci.yml:
   ```yaml
   - name: Install X11/XTest dependencies
     if: runner.os == 'Linux'
     run: |
       sudo apt-get update
       sudo apt-get install -y \
         libxkbcommon-dev libxcb-xinerama0 libxcb-cursor0 \
         libxkbcommon-x11-0 libxtst-dev libx11-dev
   ```

6. **Configure probe (Linux)**:
   ```yaml
   - name: Configure (Linux)
     if: runner.os == 'Linux'
     run: |
       cmake --preset ci-linux \
         -DCMAKE_PREFIX_PATH="${{ steps.qt.outputs.qt-dir }}"
   ```

7. **Configure probe (Windows)**:
   ```yaml
   - name: Configure (Windows)
     if: runner.os == 'Windows'
     shell: pwsh
     run: |
       cmake --preset ci-windows `
         -DCMAKE_PREFIX_PATH="${{ steps.qt.outputs.qt-dir }}"
   ```

8. **Build probe**:
   ```yaml
   - name: Build
     run: cmake --build --preset ${{ matrix.preset }} --parallel
   ```

9. **Test probe**:
   ```yaml
   - name: Test
     run: ctest --preset ${{ matrix.preset }} --output-on-failure
   ```

10. **Install probe**:
    ```yaml
    - name: Install
      run: cmake --install build/${{ matrix.preset }} --prefix install/${{ matrix.preset }}
    ```

11. **Verify install layout (Linux)**: Same as ci.yml but with `artifact_tag: qt5.15-patched`:
    ```yaml
    - name: Verify install layout (Linux)
      if: runner.os == 'Linux'
      run: |
        PROBE_DIR="install/${{ matrix.preset }}/lib/qtmcp/qt5.15"
        echo "Checking probe directory: $PROBE_DIR"
        ls -la "$PROBE_DIR"
        FILE_COUNT=$(find "$PROBE_DIR" -type f | wc -l)
        if [ "$FILE_COUNT" -eq 0 ]; then
          echo "::error::No probe files found in $PROBE_DIR"
          exit 1
        fi
        echo "Found $FILE_COUNT file(s) in probe directory"
    ```

12. **Verify install layout (Windows)**: Same as ci.yml adapted:
    ```yaml
    - name: Verify install layout (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $probeDir = "install/${{ matrix.preset }}/lib/qtmcp/qt5.15"
        Write-Host "Checking probe directory: $probeDir"
        if (-not (Test-Path $probeDir)) {
          Write-Error "Probe directory not found: $probeDir"
          exit 1
        }
        Get-ChildItem -Path $probeDir -Recurse
        $files = Get-ChildItem -Path $probeDir -File
        if ($files.Count -eq 0) {
          Write-Error "No probe files found in $probeDir"
          exit 1
        }
        Write-Host "Found $($files.Count) file(s) in probe directory"
    ```

13. **Upload artifact**:
    ```yaml
    - name: Upload probe artifact
      uses: actions/upload-artifact@v4
      with:
        name: qtmcp-qt5.15-patched-${{ matrix.platform }}
        path: install/${{ matrix.preset }}/
        retention-days: 7
        if-no-files-found: error
    ```

14. **Report Qt cache status**: A summary step that logs whether Qt was built from source or restored from cache:
    ```yaml
    - name: Summary
      if: always()
      run: |
        echo "## Patched Qt 5.15.1 / ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.qt.outputs.cache-hit }}" = "true" ]; then
          echo "Qt restored from cache" >> $GITHUB_STEP_SUMMARY
        else
          echo "Qt built from source (cache miss)" >> $GITHUB_STEP_SUMMARY
        fi
    ```

**Key design decisions:**
- Artifact names use `qt5.15-patched` suffix to distinguish from standard ci.yml's `qt5.15` artifacts
- The probe's install directory uses `qt5.15` (not `qt5.15-patched`) because the artifact_tag in CMakeLists comes from the Qt version, not whether it's patched
- Windows uses `windows-2022` explicitly (not `windows-latest`) for MSVC v142 compatibility
- MSVC dev cmd is set up BEFORE the composite action (composite actions can't use `uses:` for marketplace actions)
- The workflow path filter includes `.ci/patches/**` so patch changes trigger a rebuild
  </action>
  <verify>
1. Read `.github/workflows/ci-patched-qt.yml` and confirm:
   - Triggers: push to main only (no pull_request), workflow_dispatch present
   - Path filters include `.ci/patches/**` and `.github/actions/build-qt/**`
   - Matrix has 2 entries: ubuntu-22.04/linux-gcc and windows-2022/windows-msvc
   - timeout-minutes: 120 on the build job
   - `ilammy/msvc-dev-cmd@v1` used with toolset 14.29 for Windows
   - Composite action called with correct inputs (qt-version, patches-dir)
   - CMAKE_PREFIX_PATH set from composite action's qt-dir output
   - vcpkg setup matches ci.yml (same commit ID, same manifest features)
   - Artifact names include "patched" to distinguish from standard CI
   - Install layout verification present for both platforms
2. Validate YAML syntax: `python -c "import yaml; yaml.safe_load(open('.github/workflows/ci-patched-qt.yml'))"`
3. Verify workflow is separate from ci.yml (different filename, different triggers)
  </verify>
  <done>Complete ci-patched-qt.yml workflow with 2 matrix cells, composite action integration, MSVC v142 pinning, and artifact upload</done>
</task>

</tasks>

<verification>
1. `.github/workflows/ci-patched-qt.yml` exists and is valid YAML
2. Workflow triggers on push to main only (not PRs) + workflow_dispatch
3. Two matrix cells: Linux (ubuntu-22.04) and Windows (windows-2022)
4. 120-minute timeout per job
5. MSVC toolset pinned to v142 (14.29) for Windows
6. Composite action called with qt-version and patches-dir inputs
7. Probe configured with CMAKE_PREFIX_PATH from composite action output
8. vcpkg settings match standard CI (same commit ID, extras feature only)
9. Artifact upload with "patched" in name to distinguish from standard CI
10. Workflow is completely separate from ci.yml
</verification>

<success_criteria>
- Workflow file passes YAML validation
- 2 matrix cells defined (Linux + Windows) with correct OS pinning
- Composite action wired correctly (inputs, outputs used for CMAKE_PREFIX_PATH)
- MSVC environment set up before composite action on Windows
- Workflow isolated from standard CI (separate file, different trigger rules)
- Artifact naming distinguishes patched from standard builds
</success_criteria>

<output>
After completion, create `.planning/phases/10-patched-qt-ci/10-02-SUMMARY.md`
</output>
