---
phase: 11.1-qt5-qt6-source-compatibility
plan: 02
type: execute
wave: 2
depends_on: ["11.1-01"]
files_modified:
  - CMakeLists.txt
  - .github/workflows/ci.yml
  - .github/workflows/release.yml
autonomous: true

must_haves:
  truths:
    - "CMake fails with a clear error if Qt version is below 5.15.1 (Qt5) or 6.5 (Qt6)"
    - "QT_DISABLE_DEPRECATED_BEFORE is set to Qt 5.15.0 so pre-5.15 deprecated APIs cause build errors"
    - "CI matrix covers Qt 5.15.2, 6.5.x, 6.8.0, 6.9.0 (no 6.2 row)"
    - "CI passes green on all matrix cells after source compat changes from Plan 01"
  artifacts:
    - path: "CMakeLists.txt"
      provides: "Minimum Qt version enforcement and deprecation guard"
      contains: "QT_DISABLE_DEPRECATED_BEFORE"
    - path: ".github/workflows/ci.yml"
      provides: "Updated CI matrix with Qt 6.5 replacing Qt 6.2"
  key_links:
    - from: "CMakeLists.txt"
      to: "Qt version detection"
      via: "message(FATAL_ERROR) on version below minimum"
      pattern: "FATAL_ERROR.*minimum"
    - from: ".github/workflows/ci.yml"
      to: "CI build matrix"
      via: "matrix.include entries"
      pattern: "qt_version.*6\\.5"
---

<objective>
Enforce minimum Qt version requirements in CMake, set QT_DISABLE_DEPRECATED_BEFORE, and update the CI matrix to replace Qt 6.2 with Qt 6.5.

Purpose: Prevent accidental use of pre-5.15 deprecated APIs at compile time, enforce the project's minimum version policy, and ensure CI validates against the correct set of Qt versions.

Output: Updated CMakeLists.txt with version guards and deprecation define; updated CI workflow with Qt 6.5 replacing Qt 6.2.
</objective>

<execution_context>
@C:\Users\stjohnson\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\stjohnson\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11.1-qt5-qt6-source-compatibility/11.1-RESEARCH.md
@.planning/phases/11.1-qt5-qt6-source-compatibility/11.1-01-SUMMARY.md

Key files to modify:
@CMakeLists.txt
@.github/workflows/ci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CMake minimum version enforcement and deprecation guard</name>
  <files>CMakeLists.txt</files>
  <action>
Make two changes to the root CMakeLists.txt:

**1. Update minimum version constants and add enforcement:**
Change the existing version constants:
```cmake
set(QT_MIN_VERSION_5 "5.15.1")  # was "5.15"
set(QT_MIN_VERSION_6 "6.5")      # was "6.0"
```

After the `if(NOT Qt6_FOUND AND NOT Qt5_FOUND)` block (around line 130-132), add a version enforcement block:
```cmake
# Enforce minimum patch versions
if(Qt5_FOUND AND QT_VERSION VERSION_LESS "5.15.1")
    message(FATAL_ERROR "Qt ${QT_VERSION} is below minimum supported version 5.15.1. "
        "Please upgrade your Qt 5 installation.")
endif()
if(Qt6_FOUND AND QT_VERSION VERSION_LESS "6.5")
    message(FATAL_ERROR "Qt ${QT_VERSION} is below minimum supported version 6.5. "
        "Please upgrade your Qt 6 installation.")
endif()
```

**2. Add QT_DISABLE_DEPRECATED_BEFORE:**
After the version enforcement block, add:
```cmake
# Suppress APIs deprecated before Qt 5.15.0 — forces use of modern equivalents
add_definitions(-DQT_DISABLE_DEPRECATED_BEFORE=0x050F00)
```
The hex value 0x050F00 corresponds to Qt 5.15.0.

These changes ensure:
- Clear error message if someone tries to build against Qt 5.14 or Qt 6.2
- Compile-time errors if any code accidentally uses APIs deprecated before Qt 5.15.0
  </action>
  <verify>
1. Grep CMakeLists.txt for `QT_DISABLE_DEPRECATED_BEFORE` — should find the define.
2. Grep CMakeLists.txt for `5.15.1` and `6.5` — should find the minimum version constants.
3. Grep CMakeLists.txt for `FATAL_ERROR.*minimum` — should find two enforcement messages.
4. If a local build environment is available, verify build still passes.
  </verify>
  <done>CMake enforces Qt 5.15.1+ and Qt 6.5+ minimums with clear error messages. QT_DISABLE_DEPRECATED_BEFORE set to 5.15.0.</done>
</task>

<task type="auto">
  <name>Task 2: Update CI matrix — replace Qt 6.2 with Qt 6.5</name>
  <files>.github/workflows/ci.yml</files>
  <action>
In `.github/workflows/ci.yml`, replace the two Qt 6.2.4 matrix entries with Qt 6.5.3:

Replace the `# ---- Qt 6.2 ----` section (both Linux and Windows entries):

**Before:**
```yaml
          # ---- Qt 6.2 ----
          - qt_version: "6.2.4"
            qt_major: 6
            os: ubuntu-24.04
            platform: linux-gcc
            preset: ci-linux
            artifact_tag: qt6.2
            qt_modules: "qtwebsockets"
          - qt_version: "6.2.4"
            qt_major: 6
            os: windows-latest
            platform: windows-msvc
            preset: ci-windows
            artifact_tag: qt6.2
            qt_modules: "qtwebsockets"
```

**After:**
```yaml
          # ---- Qt 6.5 ----
          - qt_version: "6.5.3"
            qt_major: 6
            os: ubuntu-24.04
            platform: linux-gcc
            preset: ci-linux
            artifact_tag: qt6.5
            qt_modules: "qtwebsockets"
          - qt_version: "6.5.3"
            qt_major: 6
            os: windows-latest
            platform: windows-msvc
            preset: ci-windows
            artifact_tag: qt6.5
            qt_modules: "qtwebsockets"
```

Key changes:
- `qt_version`: "6.2.4" → "6.5.3"
- `artifact_tag`: qt6.2 → qt6.5
- Comment: Qt 6.2 → Qt 6.5
- Everything else stays the same (os, preset, qt_modules)

In `.github/workflows/release.yml`, replace `qtmcp-qt6.2-linux-gcc:qt6.2` with `qtmcp-qt6.5-linux-gcc:qt6.5` and `qtmcp-qt6.2-windows-msvc:qt6.2` with `qtmcp-qt6.5-windows-msvc:qt6.5` (lines 42-43). Also check `ci-patched-qt.yml` for any qt6.2 references and update if found.
  </action>
  <verify>
1. Grep `.github/workflows/ci.yml` for `6.2` — should find zero matches.
2. Grep `.github/workflows/ci.yml` for `6.5.3` — should find two matches (Linux and Windows entries).
3. Grep `.github/workflows/ci.yml` for `qt6.5` — should find two matches (artifact_tag).
4. Grep `.github/workflows/release.yml` for `6.2` — should find zero matches.
5. Verify the total matrix is still 8 cells (4 Qt versions x 2 platforms): 5.15.2, 6.5.3, 6.8.0, 6.9.0.
  </verify>
  <done>CI matrix covers Qt 5.15.2, 6.5.3, 6.8.0, 6.9.0 on both Linux and Windows. No Qt 6.2 references remain.</done>
</task>

</tasks>

<verification>
1. CMakeLists.txt has `QT_DISABLE_DEPRECATED_BEFORE=0x050F00`
2. CMakeLists.txt rejects Qt < 5.15.1 and Qt < 6.5 with FATAL_ERROR
3. CI workflow has exactly 8 matrix cells: qt5.15, qt6.5, qt6.8, qt6.9 x linux, windows
4. No references to "6.2" remain in any workflow file
5. Push to branch triggers CI and all cells pass green (verified after merge)
</verification>

<success_criteria>
- CMake minimum versions enforced: Qt 5.15.1+ and Qt 6.5+
- QT_DISABLE_DEPRECATED_BEFORE=0x050F00 active for all targets
- CI matrix updated from Qt 6.2 to Qt 6.5
- All 8 CI cells pass (verified by CI run after push)
</success_criteria>

<output>
After completion, create `.planning/phases/11.1-qt5-qt6-source-compatibility/11.1-02-SUMMARY.md`
</output>
