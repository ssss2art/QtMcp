---
phase: 12-vcpkg-port
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ports/qtmcp/portfile.cmake
  - ports/qtmcp/vcpkg.json
  - ports/qtmcp/usage
autonomous: true

must_haves:
  truths:
    - "vcpkg install qtmcp --overlay-ports=./ports builds probe from source against user's Qt"
    - "Source port auto-detects Qt major.minor version and produces correctly named artifact"
    - "After install, find_package(QtMCP) and target_link_libraries(app QtMCP::Probe) works"
    - "Port works with both Qt5 and Qt6 installations"
    - "Usage instructions are shown after install"
  artifacts:
    - path: "ports/qtmcp/vcpkg.json"
      provides: "Port manifest with no qtbase dependency"
      contains: "qtmcp"
      min_lines: 5
    - path: "ports/qtmcp/portfile.cmake"
      provides: "Source build portfile using vcpkg_from_github"
      contains: "vcpkg_from_github"
      min_lines: 20
    - path: "ports/qtmcp/usage"
      provides: "Post-install usage instructions"
      contains: "find_package(QtMCP)"
  key_links:
    - from: "ports/qtmcp/portfile.cmake"
      to: "CMakeLists.txt"
      via: "vcpkg_cmake_configure invokes project CMakeLists.txt"
      pattern: "vcpkg_cmake_configure"
    - from: "ports/qtmcp/portfile.cmake"
      to: "cmake/QtMCPConfig.cmake.in"
      via: "vcpkg_cmake_install triggers configure_package_config_file"
      pattern: "vcpkg_cmake_install"
---

<objective>
Create the source overlay port for QtMCP that builds the probe from source against the user's existing Qt installation.

Purpose: Enables users to install QtMCP via `vcpkg install qtmcp --overlay-ports=./ports`, compiling the probe against their own Qt (5.15+ or 6.5+) for exact ABI compatibility.

Output: Complete source overlay port at `ports/qtmcp/` with portfile, manifest, and usage instructions.
</objective>

<execution_context>
@C:\Users\stjohnson\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\stjohnson\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-vcpkg-port/12-CONTEXT.md

Key files that define the build/install:
@CMakeLists.txt
@cmake/QtMCPConfig.cmake.in
@cmake/qtmcp_inject_probe.cmake
@src/probe/CMakeLists.txt
@vcpkg.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create source overlay port</name>
  <files>
    ports/qtmcp/vcpkg.json
    ports/qtmcp/portfile.cmake
    ports/qtmcp/usage
  </files>
  <action>
Create directory `ports/qtmcp/` if it does not exist.

**ports/qtmcp/vcpkg.json:**
```json
{
  "name": "qtmcp",
  "version": "0.1.0",
  "description": "Qt application introspection and automation library with MCP integration",
  "homepage": "https://github.com/ssss2art/QtMcp",
  "license": "MIT",
  "supports": "windows | linux",
  "dependencies": [
    {
      "name": "vcpkg-cmake",
      "host": true
    },
    {
      "name": "vcpkg-cmake-config",
      "host": true
    }
  ]
}
```

IMPORTANT: Do NOT declare qtbase, qtwebsockets, or any Qt dependency. The port relies on Qt already being installed on the system (either via vcpkg or externally). The project's CMakeLists.txt already does find_package(Qt6/Qt5) and will find whatever Qt is available.

**ports/qtmcp/portfile.cmake:**
```cmake
vcpkg_from_github(
    OUT_SOURCE_PATH SOURCE_PATH
    REPO ssss2art/QtMcp
    REF "v${VERSION}"
    SHA512 0  # Placeholder - must be updated when first release tag is created
    HEAD_REF main
)

vcpkg_cmake_configure(
    SOURCE_PATH "${SOURCE_PATH}"
    OPTIONS
        -DQTMCP_BUILD_TESTS=OFF
        -DQTMCP_BUILD_TEST_APP=OFF
        -DQTMCP_ENABLE_CLANG_TIDY=OFF
        -DQTMCP_DEPLOY_QT=OFF
)

vcpkg_cmake_install()

# Fix up the CMake config files (moves from share/cmake/QtMCP/ to share/qtmcp/)
vcpkg_cmake_config_fixup(PACKAGE_NAME QtMCP CONFIG_PATH share/cmake/QtMCP)

# Remove empty include directory if no headers were installed
# (probe is a shared library loaded via injection, headers aren't typically needed by consumers)
file(REMOVE_RECURSE "${CURRENT_PACKAGES_DIR}/debug/include")

# Remove duplicate tools/binaries from debug
file(REMOVE_RECURSE "${CURRENT_PACKAGES_DIR}/debug/bin/qtmcp-launcher${VCPKG_TARGET_EXECUTABLE_SUFFIX}")
if(EXISTS "${CURRENT_PACKAGES_DIR}/debug/share")
    file(REMOVE_RECURSE "${CURRENT_PACKAGES_DIR}/debug/share")
endif()

# Install usage instructions
file(INSTALL "${CMAKE_CURRENT_LIST_DIR}/usage" DESTINATION "${CURRENT_PACKAGES_DIR}/share/${PORT}")

# Install license
vcpkg_install_copyright(FILE_LIST "${SOURCE_PATH}/LICENSE")
```

Key design notes:
- `SHA512 0` is a placeholder. vcpkg will error on install until a real hash is provided. This is standard for ports under active development — the hash gets updated when the first release tag exists. Include a comment explaining this.
- `-DQTMCP_BUILD_TESTS=OFF` and `-DQTMCP_BUILD_TEST_APP=OFF` skip test targets.
- `-DQTMCP_DEPLOY_QT=OFF` prevents windeployqt from running (vcpkg handles runtime dependencies).
- `vcpkg_cmake_config_fixup` moves the CMake config from the project's install path (`share/cmake/QtMCP`) to vcpkg's expected path (`share/qtmcp`). This needs PACKAGE_NAME QtMCP because our project uses `QtMCP` as the package name.
- The port does NOT strip the debug libraries — vcpkg handles debug/release splitting automatically via `vcpkg_cmake_install()`.

**ports/qtmcp/usage:**
```
qtmcp provides CMake targets:

  find_package(QtMCP CONFIG REQUIRED)
  target_link_libraries(main PRIVATE QtMCP::Probe)

The probe is loaded via injection (LD_PRELOAD on Linux, DLL injection on Windows).
See the project README for injection instructions.
```

IMPORTANT: After creating the files, verify the directory structure is:
```
ports/
  qtmcp/
    portfile.cmake
    vcpkg.json
    usage
```
  </action>
  <verify>
1. `ports/qtmcp/vcpkg.json` exists and is valid JSON (`python -c "import json; json.load(open('ports/qtmcp/vcpkg.json'))"`)
2. `ports/qtmcp/portfile.cmake` contains `vcpkg_from_github`, `vcpkg_cmake_configure`, `vcpkg_cmake_install`, and `vcpkg_cmake_config_fixup`
3. `ports/qtmcp/vcpkg.json` does NOT contain `qtbase` or `qtwebsockets` in dependencies
4. `ports/qtmcp/usage` exists and mentions `find_package(QtMCP)`
5. portfile.cmake passes `-DQTMCP_BUILD_TESTS=OFF` and `-DQTMCP_BUILD_TEST_APP=OFF`
  </verify>
  <done>Source overlay port exists at ports/qtmcp/ with portfile (vcpkg_from_github + cmake build), manifest (no Qt deps), and usage instructions. Port delegates Qt detection entirely to the project's own CMakeLists.txt.</done>
</task>

</tasks>

<verification>
1. `ports/qtmcp/vcpkg.json` is valid JSON with name "qtmcp"
2. `ports/qtmcp/portfile.cmake` uses vcpkg_from_github, vcpkg_cmake_configure, vcpkg_cmake_install, vcpkg_cmake_config_fixup
3. No Qt dependencies declared in vcpkg.json
4. Usage file contains find_package instructions
5. Build options disable tests and test app
</verification>

<success_criteria>
- Source overlay port directory exists at ports/qtmcp/ with all three required files
- Port manifest declares no Qt dependencies (user provides their own Qt)
- Portfile builds using project's existing CMake system with tests disabled
- CMake config fixup relocates QtMCPConfig.cmake to vcpkg-standard path
- Usage instructions explain find_package and injection workflow
</success_criteria>

<output>
After completion, create `.planning/phases/12-vcpkg-port/12-01-SUMMARY.md`
</output>
