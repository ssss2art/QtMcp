---
phase: 13-pypi-publication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - python/src/qtmcp/download.py
  - python/src/qtmcp/cli.py
  - python/tests/test_download.py
autonomous: true

must_haves:
  truths:
    - "qtmcp download-probe --qt-version 6.8 downloads correct probe binary"
    - "Platform auto-detection works (linux-gcc on Linux, windows-msvc on Windows)"
    - "Downloaded probe is placed in user-specified or default location"
    - "Download verifies SHA256 checksum from SHA256SUMS file"
  artifacts:
    - path: "python/src/qtmcp/download.py"
      provides: "Probe download logic with platform detection and checksum verification"
      exports: ["download_probe"]
    - path: "python/src/qtmcp/cli.py"
      provides: "CLI with download-probe subcommand"
      contains: "download-probe"
    - path: "python/tests/test_download.py"
      provides: "Unit tests for download module"
      min_lines: 30
  key_links:
    - from: "python/src/qtmcp/cli.py"
      to: "python/src/qtmcp/download.py"
      via: "import and subcommand handler"
      pattern: "from qtmcp.download import"
    - from: "python/src/qtmcp/download.py"
      to: "GitHub Releases"
      via: "urllib/httpx HTTP GET"
      pattern: "github.com.*releases.*download"
---

<objective>
Add `download-probe` CLI subcommand that fetches the correct probe binary from GitHub Releases.

Purpose: Users need an easy way to get the probe DLL/SO for their Qt version without manually navigating GitHub Releases. This completes the "pip install -> working setup" user story.

Output: Working `qtmcp download-probe --qt-version 6.8` command that downloads, verifies, and places the probe binary.
</objective>

<execution_context>
@C:\Users\stjohnson\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\stjohnson\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@python/src/qtmcp/cli.py
@python/pyproject.toml
@.github/workflows/release.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create download module with probe fetching logic</name>
  <files>python/src/qtmcp/download.py</files>
  <action>
Create `download.py` module with:

1. **Constants:**
   - `GITHUB_REPO = "anthropics/qtmcp"` (or actual repo path)
   - `RELEASES_URL = f"https://github.com/{GITHUB_REPO}/releases/download"`
   - Mapping of Qt versions to release tags (e.g., qt6.8 -> latest release)

2. **Platform detection:**
   - Detect OS via `sys.platform` (linux, win32)
   - Map to artifact suffix: linux -> `linux-gcc`, win32 -> `windows-msvc`
   - File extension: linux -> `.so`, win32 -> `.dll`

3. **`download_probe(qt_version, output_dir=None, verify_checksum=True)` function:**
   - Build artifact URL: `{RELEASES_URL}/v{release}/qtmcp-probe-qt{version}-{platform}.{ext}`
   - Download SHA256SUMS first if verify_checksum=True
   - Download probe binary to output_dir (default: current directory)
   - Verify SHA256 matches if checksums fetched
   - Return path to downloaded file
   - Raise clear errors on failure (network, checksum mismatch, etc.)

4. **Use only stdlib** (urllib.request, hashlib, pathlib) - no new dependencies.

5. **Handle edge cases:**
   - Qt version normalization (6.8 vs 6.8.0)
   - "patched" suffix for qt5.15-patched variant
   - HTTP errors (404 for missing version, network issues)
  </action>
  <verify>
Run: `python -c "from qtmcp.download import download_probe; print(download_probe.__doc__)"`
Should print function docstring without import errors.
  </verify>
  <done>
download.py exists with download_probe function that can build URLs and has platform detection logic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add download-probe subcommand to CLI</name>
  <files>python/src/qtmcp/cli.py</files>
  <action>
Refactor cli.py to support subcommands:

1. **Convert to subcommand architecture:**
   - Create parent parser with subparsers
   - Move existing server args to `serve` subcommand
   - Add `download-probe` subcommand

2. **`download-probe` subcommand arguments:**
   - `--qt-version` (required): e.g., "6.8", "5.15", "5.15-patched"
   - `--output-dir` (optional): where to place the probe (default: current directory)
   - `--no-verify` (optional): skip SHA256 verification
   - `--release` (optional): specific release tag (default: latest)

3. **Backward compatibility:**
   - `qtmcp --mode native` should still work (server is default when no subcommand)
   - OR require `qtmcp serve --mode native` (breaking change - document in help)

   **Decision: Require `qtmcp serve`** - cleaner separation, users just installing won't have existing scripts.

4. **Implementation:**
   - Import download_probe from download module
   - Call download_probe with parsed args
   - Print success message with path to downloaded file
   - Exit 0 on success, 1 on failure with error message

5. **Help text should clearly explain:**
   - What Qt versions are available
   - Platform auto-detection behavior
   - Where files are placed by default
  </action>
  <verify>
Run: `cd python && python -m qtmcp download-probe --help`
Should show download-probe subcommand help with --qt-version, --output-dir arguments.
  </verify>
  <done>
CLI has download-probe subcommand. `qtmcp download-probe --qt-version 6.8 --help` works.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for download module</name>
  <files>python/tests/test_download.py</files>
  <action>
Create test_download.py with:

1. **Platform detection tests:**
   - Test linux platform -> linux-gcc suffix
   - Test win32 platform -> windows-msvc suffix
   - Mock sys.platform for cross-platform testing

2. **URL building tests:**
   - Test URL format for qt6.8 on linux
   - Test URL format for qt5.15-patched on windows
   - Test release tag interpolation

3. **Checksum verification tests:**
   - Test parsing SHA256SUMS file format
   - Test checksum match (should pass)
   - Test checksum mismatch (should raise error)
   - Mock file content for testing

4. **Error handling tests:**
   - Test handling of 404 (version not found)
   - Test handling of network errors

Use pytest and unittest.mock for mocking HTTP requests.
Do NOT make actual network requests in tests.
  </action>
  <verify>
Run: `cd python && python -m pytest tests/test_download.py -v`
All tests should pass.
  </verify>
  <done>
test_download.py exists with passing tests covering platform detection, URL building, and checksum verification.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from qtmcp.download import download_probe"` - imports without error
2. `cd python && python -m qtmcp download-probe --help` - shows subcommand help
3. `cd python && python -m pytest tests/test_download.py -v` - all tests pass
4. Manually verify URL building: `python -c "from qtmcp.download import build_probe_url; print(build_probe_url('6.8'))"` should print valid GitHub URL
</verification>

<success_criteria>
- download.py module exists with platform detection and URL building
- CLI has download-probe subcommand with --qt-version argument
- Unit tests pass for download logic (mocked, no actual network calls)
- CLI help is clear and explains available Qt versions
</success_criteria>

<output>
After completion, create `.planning/phases/13-pypi-publication/13-01-SUMMARY.md`
</output>
