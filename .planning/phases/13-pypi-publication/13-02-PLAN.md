---
phase: 13-pypi-publication
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - python/pyproject.toml
  - python/README.md
  - .github/workflows/publish-pypi.yml
autonomous: false

user_setup:
  - service: pypi
    why: "Package publishing"
    dashboard_config:
      - task: "Configure Trusted Publisher for qtmcp package"
        location: "PyPI -> Your projects -> qtmcp -> Publishing -> Add a new pending publisher"
        details: "Set GitHub repo owner/name, workflow filename (publish-pypi.yml), environment (pypi)"

must_haves:
  truths:
    - "pip install qtmcp from PyPI succeeds"
    - "Package appears on PyPI with correct metadata (description, URLs, classifiers)"
    - "Publishing triggers automatically on GitHub Release"
    - "No API tokens stored in repository secrets (OIDC only)"
  artifacts:
    - path: "python/pyproject.toml"
      provides: "Complete PyPI metadata"
      contains: "classifiers"
    - path: "python/README.md"
      provides: "Package long description for PyPI"
      min_lines: 20
    - path: ".github/workflows/publish-pypi.yml"
      provides: "OIDC-based PyPI publishing workflow"
      contains: "pypa/gh-action-pypi-publish"
  key_links:
    - from: ".github/workflows/publish-pypi.yml"
      to: ".github/workflows/release.yml"
      via: "Triggers on release publication"
      pattern: "on:.*release"
    - from: "python/pyproject.toml"
      to: "hatchling build backend"
      via: "build-system"
      pattern: "hatchling"
---

<objective>
Configure PyPI metadata and create publishing workflow using Trusted Publishers (OIDC).

Purpose: Enable `pip install qtmcp` from PyPI without storing API tokens in secrets. Publishing should be fully automated on release.

Output: Complete pyproject.toml metadata, package README, and GitHub Actions workflow for PyPI publishing.
</objective>

<execution_context>
@C:\Users\stjohnson\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\stjohnson\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@python/pyproject.toml
@.github/workflows/release.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Complete pyproject.toml metadata for PyPI</name>
  <files>python/pyproject.toml</files>
  <action>
Update pyproject.toml with complete PyPI metadata:

1. **Project metadata:**
   ```toml
   [project]
   name = "qtmcp"
   version = "0.1.0"
   description = "MCP server for controlling Qt applications via QtMCP probe"
   readme = "README.md"
   license = {text = "MIT"}
   requires-python = ">=3.11"
   authors = [
       {name = "Scott Johnson", email = "scott@example.com"}
   ]
   keywords = ["mcp", "qt", "automation", "testing", "claude"]
   classifiers = [
       "Development Status :: 4 - Beta",
       "Environment :: Console",
       "Intended Audience :: Developers",
       "License :: OSI Approved :: MIT License",
       "Operating System :: Microsoft :: Windows",
       "Operating System :: POSIX :: Linux",
       "Programming Language :: Python :: 3",
       "Programming Language :: Python :: 3.11",
       "Programming Language :: Python :: 3.12",
       "Topic :: Software Development :: Testing",
       "Topic :: Software Development :: Quality Assurance",
   ]
   dependencies = [
       "fastmcp>=2.0,<3",
       "websockets>=14.0",
   ]
   ```

2. **Project URLs:**
   ```toml
   [project.urls]
   Homepage = "https://github.com/anthropics/qtmcp"
   Documentation = "https://github.com/anthropics/qtmcp#readme"
   Repository = "https://github.com/anthropics/qtmcp"
   Issues = "https://github.com/anthropics/qtmcp/issues"
   Changelog = "https://github.com/anthropics/qtmcp/releases"
   ```

3. **Keep existing scripts entry:**
   ```toml
   [project.scripts]
   qtmcp = "qtmcp.cli:main"
   ```

4. **Build system (keep hatchling):**
   ```toml
   [build-system]
   requires = ["hatchling"]
   build-backend = "hatchling.build"
   ```

Note: Use the actual repository owner (likely not "anthropics" - check .git/config).
  </action>
  <verify>
Run: `cd python && python -m build --sdist --wheel --no-isolation 2>&1 | head -20`
Or if build not installed: `cd python && pip install build && python -m build --sdist`
Should produce dist/qtmcp-0.1.0.tar.gz and dist/qtmcp-0.1.0-py3-none-any.whl
  </verify>
  <done>
pyproject.toml has complete metadata. Package builds successfully as pure-Python wheel.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create package README for PyPI</name>
  <files>python/README.md</files>
  <action>
Create python/README.md that serves as PyPI long description:

1. **Title and badges:**
   ```markdown
   # qtmcp

   MCP server for controlling Qt applications via the QtMCP probe.
   ```

2. **Installation:**
   ```markdown
   ## Installation

   ```bash
   pip install qtmcp
   ```

3. **Quick Start:**
   - Show how to download the probe for your Qt version
   - Show how to launch the MCP server
   - Brief example of connecting Claude

4. **Features:**
   - Three API modes (Native, Computer Use, Chrome)
   - 53 MCP tools for Qt introspection
   - Works with Qt 5.15 and Qt 6.x

5. **Probe Download:**
   ```markdown
   ## Getting the Probe

   ```bash
   # Download probe for your Qt version
   qtmcp download-probe --qt-version 6.8

   # Or specify Qt 5.15 patched variant
   qtmcp download-probe --qt-version 5.15-patched
   ```

6. **Running the Server:**
   ```markdown
   ## Usage

   ```bash
   # Start MCP server (connects to running Qt app with probe loaded)
   qtmcp serve --mode native --ws-url ws://localhost:9222

   # Or auto-launch a Qt app with probe injection
   qtmcp serve --mode chrome --target /path/to/myapp.exe
   ```

7. **Links:**
   - Link to main repo README for full documentation
   - Link to releases for probe binaries
   - Link to issues for bug reports

Keep it concise (50-100 lines). This is PyPI landing page, not full docs.
  </action>
  <verify>
Run: `test -f python/README.md && wc -l python/README.md`
Should exist with 50-100 lines.
  </verify>
  <done>
python/README.md exists with installation, quick start, and probe download instructions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PyPI publishing workflow with Trusted Publishers</name>
  <files>.github/workflows/publish-pypi.yml</files>
  <action>
Create publish-pypi.yml workflow:

```yaml
name: Publish to PyPI

on:
  release:
    types: [published]

permissions:
  id-token: write  # Required for OIDC authentication

jobs:
  build:
    name: Build distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tools
        run: pip install build

      - name: Build package
        run: cd python && python -m build

      - name: Upload distribution artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: python/dist/

  publish-to-pypi:
    name: Publish to PyPI
    needs: [build]
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/project/qtmcp/
    steps:
      - name: Download distribution artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        # No api-token needed - uses OIDC Trusted Publisher
```

Key points:
1. Triggers on `release: published` (not `push: tags`) - runs after release.yml creates the release
2. Uses `id-token: write` permission for OIDC
3. Uses `pypa/gh-action-pypi-publish@release/v1` - official PyPI action
4. NO `password:` field - relies entirely on Trusted Publishers
5. Uses `environment: pypi` for GitHub environment protection (optional but recommended)
  </action>
  <verify>
Run: `test -f .github/workflows/publish-pypi.yml && grep -c "pypa/gh-action-pypi-publish" .github/workflows/publish-pypi.yml`
Should print 1 (file exists and contains the action).
  </verify>
  <done>
publish-pypi.yml exists with OIDC-based publishing (no API tokens).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
PyPI package configuration and publishing workflow:
1. Complete pyproject.toml with metadata and classifiers
2. Package README.md for PyPI landing page
3. GitHub Actions workflow using Trusted Publishers (OIDC)
  </what-built>
  <how-to-verify>
1. Review pyproject.toml - verify metadata looks correct
2. Review README.md - verify it's appropriate for PyPI
3. Review publish-pypi.yml - verify OIDC pattern is correct
4. Test local build: `cd python && pip install build && python -m build`
5. **IMPORTANT**: Configure Trusted Publisher on PyPI BEFORE first release:
   - Go to https://pypi.org/manage/account/publishing/
   - Add pending publisher for "qtmcp"
   - Set: GitHub owner, repo name, workflow: "publish-pypi.yml", environment: "pypi"
  </how-to-verify>
  <resume-signal>Type "approved" when PyPI Trusted Publisher is configured, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `cd python && python -m build` - produces wheel and sdist
2. `unzip -l python/dist/qtmcp-*.whl` - shows expected file structure
3. `.github/workflows/publish-pypi.yml` exists with OIDC pattern
4. No `PYPI_TOKEN` or similar secrets referenced anywhere
</verification>

<success_criteria>
- pyproject.toml has complete PyPI metadata (classifiers, URLs, readme)
- Package builds as pure-Python wheel (no compiled extensions)
- Publishing workflow uses Trusted Publishers (OIDC), no API tokens
- README.md provides clear installation and usage instructions
</success_criteria>

<output>
After completion, create `.planning/phases/13-pypi-publication/13-02-SUMMARY.md`
</output>
